<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å™è¿°å©šç¤¼ï½œæ¥å•æ‰§è¡Œç³»ç»Ÿ</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#111b27; --text:#e9f1ff; --muted:#9fb0c7;
      --line:rgba(255,255,255,.10); --brand:#7dd3fc; --brand2:#a78bfa; --ok:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --shadow: 0 12px 40px rgba(0,0,0,.40);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --panel:#ffffff; --panel2:#ffffff; --text:#0b1220; --muted:#5a6b80;
      --line:rgba(12,18,32,.10); --shadow: 0 12px 40px rgba(9,30,66,.12);
      --brand:#0ea5e9; --brand2:#7c3aed;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:
      radial-gradient(1200px 600px at 20% -10%, rgba(125,211,252,.22), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,.20), transparent 60%),
      radial-gradient(900px 600px at 50% 110%, rgba(52,211,153,.10), transparent 60%),
      var(--bg);
    }
    a{color:inherit}
    .app{display:grid; grid-template-columns: 300px 1fr; height:100%}
    @media (max-width: 980px){ .app{grid-template-columns: 1fr} .sidebar{position:fixed; inset:0 auto 0 0; width:86vw; max-width:340px; transform:translateX(-105%); transition:.2s; z-index:50} .sidebar.show{transform:translateX(0)} .overlay{display:block} }
    .overlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,.38); z-index:40}
    .overlay.show{display:block}
    .sidebar{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 22%), rgba(0,0,0,.06);
      padding:18px 16px;
    }
    .brand{
      display:flex; gap:12px; align-items:center; padding:10px 10px 14px; border-radius:14px;
      background: linear-gradient(135deg, rgba(125,211,252,.18), rgba(167,139,250,.12));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }
    .logo{
      width:42px; height:42px; border-radius:14px; display:grid; place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 55%),
                  linear-gradient(135deg, rgba(125,211,252,.95), rgba(167,139,250,.95));
      color:#061021; font-weight:900; letter-spacing:.5px;
    }
    .brand h1{margin:0; font-size:16px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .nav{margin-top:14px; display:flex; flex-direction:column; gap:6px}
    .nav button{
      all:unset; cursor:pointer; display:flex; gap:10px; align-items:center;
      padding:10px 10px; border-radius:12px; border:1px solid transparent;
      color:var(--text); background:transparent;
    }
    .nav button:hover{background:rgba(255,255,255,.04); border-color: rgba(255,255,255,.06)}
    [data-theme="light"] .nav button:hover{background:rgba(12,18,32,.04); border-color: rgba(12,18,32,.06)}
    .nav button.active{
      background: linear-gradient(135deg, rgba(125,211,252,.16), rgba(167,139,250,.12));
      border-color: rgba(125,211,252,.25);
    }
    .nav .ico{width:20px; text-align:center; opacity:.95}
    .small{font-size:12px; color:var(--muted)}
    .main{padding:18px 18px 26px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border-radius:14px;
      background: rgba(255,255,255,.03); border:1px solid var(--line);
    }
    [data-theme="light"] .topbar{background: rgba(12,18,32,.03)}
    .top-left{display:flex; align-items:center; gap:10px}
    .hamb{display:none}
    @media (max-width:980px){ .hamb{display:inline-flex} }
    .btn{
      cursor:pointer; border:1px solid var(--line); background: rgba(255,255,255,.03);
      color:var(--text); border-radius:12px; padding:9px 12px; font-weight:600;
      display:inline-flex; gap:8px; align-items:center;
    }
    [data-theme="light"] .btn{background: rgba(12,18,32,.03)}
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      border-color: rgba(125,211,252,.35);
      background: linear-gradient(135deg, rgba(14,165,233,.30), rgba(124,58,237,.18));
    }
    .btn.danger{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.12)}
    .grid{display:grid; gap:12px; margin-top:14px}
    .grid.cols2{grid-template-columns: 1fr 1fr}
    .grid.cols3{grid-template-columns: 1fr 1fr 1fr}
    @media (max-width: 1100px){ .grid.cols3{grid-template-columns:1fr} .grid.cols2{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 18%), var(--panel);
      border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px}
    .card .hd h2{margin:0; font-size:14px}
    .card .bd{padding:14px}
    .kpi{display:flex; flex-direction:column; gap:6px}
    .kpi .v{font-size:22px; font-weight:800}
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.03); color:var(--muted); font-size:12px
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .sep{height:1px; background:var(--line); margin:12px 0}
    input, select, textarea{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.02); color:var(--text);
      outline:none;
    }
    [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{background: rgba(12,18,32,.02)}
    textarea{min-height: 92px; resize: vertical}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    .formgrid{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
    @media (max-width: 900px){ .formgrid{grid-template-columns:1fr} }
    .tableWrap{overflow:auto; border:1px solid var(--line); border-radius:14px}
    table{width:100%; border-collapse:collapse; min-width:720px; background: rgba(255,255,255,.02)}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top}
    th{font-size:12px; color:var(--muted); position:sticky; top:0; background: rgba(0,0,0,.22)}
    [data-theme="light"] th{background: rgba(255,255,255,.8)}
    tr:hover td{background: rgba(255,255,255,.03)}
    .check{
      width:18px; height:18px; border-radius:6px; border:1px solid var(--line);
      display:inline-grid; place-items:center; cursor:pointer; user-select:none;
    }
    .check.done{background: rgba(52,211,153,.22); border-color: rgba(52,211,153,.55)}
    .muted{color:var(--muted)}
    .tag{display:inline-flex; padding:5px 9px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.02); font-size:12px; margin:2px 6px 0 0}
    .notice{
      padding:10px 12px; border-radius:14px; border:1px solid rgba(125,211,252,.30);
      background: rgba(125,211,252,.10); color: var(--text);
    }
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:100;
      display:flex; flex-direction:column; gap:10px;
    }
    .toast .t{
      min-width:260px; max-width:360px;
      padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(0,0,0,.55); backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    [data-theme="light"] .toast .t{background: rgba(255,255,255,.92)}
    .t b{display:block; margin-bottom:2px}
    .hidden{display:none !important}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      cursor:pointer; padding:8px 10px; border-radius:12px; border:1px solid var(--line);
      background: rgba(255,255,255,.02); color: var(--muted); font-weight:700; font-size:12px;
    }
    .tab.active{color:var(--text); border-color: rgba(125,211,252,.35); background: rgba(125,211,252,.10)}
    .progress{
      height:10px; border-radius:999px; border:1px solid var(--line); overflow:hidden; background: rgba(255,255,255,.03);
    }
    .bar{height:100%; width:0%; background: linear-gradient(90deg, rgba(52,211,153,.85), rgba(125,211,252,.85))}
    
    /* Schedule Calendar */
    .calWrap{display:flex; flex-direction:column; gap:10px}
    .calHead{display:grid; grid-template-columns:repeat(7, 1fr); gap:8px}
    .calHead div{font-size:12px; color:var(--muted); text-align:center; padding:8px 0; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02)}
    .calGrid{display:grid; grid-template-columns:repeat(7, 1fr); gap:8px}
    .calDay{
      min-height:96px; padding:10px; border-radius:14px; border:1px solid var(--line);
      background: rgba(255,255,255,.02); cursor:pointer; position:relative;
      transition: transform .12s ease;
    }
    .calDay:hover{transform: translateY(-1px)}
    .calDay.out{opacity:.45}
    .calDay.has{border-color: rgba(125,211,252,.35); background: rgba(125,211,252,.08)}
    .calNum{font-weight:900; font-size:14px}
    .calMeta{margin-top:6px; font-size:11px; color:var(--muted); line-height:1.35}
    .calBadge{
      position:absolute; right:10px; top:10px;
      padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); font-size:12px; color:var(--text);
    }
    .listGroup{margin-bottom:12px}
    .listGroup .dateTitle{font-weight:900; margin:0 0 8px}
    .miniCard{
      border:1px solid var(--line); border-radius:14px; padding:10px 12px;
      background: rgba(255,255,255,.02);
      margin-bottom:8px;
    }
    .miniCard .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}

    
    /* Print Area (day run sheet) */
    body.printing *{visibility:hidden !important}
    body.printing #printArea, body.printing #printArea *{visibility:visible !important}
    body.printing #printArea{display:block !important; position:fixed; inset:0; padding:0; background:#fff}
    #printArea{display:none}
    #printArea.show{display:block}
    .a4{
      width:210mm; min-height:297mm; margin:0 auto; padding:14mm 14mm 12mm;
      color:#111; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    }
    .a4 h1{margin:0 0 6mm; font-size:18px}
    .a4 .meta{display:flex; justify-content:space-between; gap:8mm; font-size:12px; color:#333}
    .a4 .hr{height:1px; background:#ddd; margin:5mm 0}
    .a4 .box{border:1px solid #ddd; border-radius:10px; padding:10px 12px; margin:0 0 5mm}
    .a4 .row{display:flex; gap:8mm; flex-wrap:wrap}
    .a4 .pill{display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; font-size:12px}
    .a4 table{width:100%; border-collapse:collapse; font-size:12px; min-width:0; background:#fff}
    .a4 th,.a4 td{border:1px solid #ddd; padding:7px 8px; vertical-align:top}
    .a4 th{background:#f6f6f6; text-align:left}
    .a4 .muted{color:#666}
    .a4 .sig{display:flex; justify-content:space-between; gap:10mm; margin-top:6mm}
    .a4 .sig div{border-top:1px solid #bbb; padding-top:3mm; width:48%}
    .a4 .noteLines{height:26mm; border:1px dashed #bbb; border-radius:10px; padding:8px; color:#777}
    @media print{
      .sidebar, .topbar, .btn, .toast, .overlay{display:none !important}
      body{background:#fff}
      .main{padding:0}
      .card{box-shadow:none; border:1px solid #ddd}
      table{min-width:0}
    }
  </style>
</head>
<body>
<div class="overlay" id="overlay" data-action="closeSidebar"></div>

<div class="app" id="app">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">AN</div>
      <div>
        <h1>å™è¿°å©šç¤¼ï½œæ¥å•æ‰§è¡Œç³»ç»Ÿ</h1>
        <p>å®¢æˆ· â†’ æ–¹æ¡ˆ â†’ æ‰§è¡Œ â†’ äº¤ä»˜ï¼ˆå•æ–‡ä»¶ç¦»çº¿ç‰ˆï¼‰</p>
      </div>
    </div>

    <div class="nav" id="nav">
      <button class="active" data-view="dashboard"><span class="ico">ğŸ </span>ä»ªè¡¨ç›˜ <span class="small">æ€»è§ˆ</span></button>
      <button data-view="schedule"><span class="ico">ğŸ“…</span>æ¡£æœŸè®°å½• <span class="small">æ—¥å†</span></button>
      <button data-view="clients"><span class="ico">ğŸ‘¥</span>å®¢æˆ·æ¡£æ¡ˆ <span class="small">ç®¡ç†</span></button>
      <button data-view="client"><span class="ico">ğŸ§¾</span>é¡¹ç›®æ‰§è¡Œ <span class="small">æ¸…å•</span></button>
      <button data-view="templates"><span class="ico">ğŸ§©</span>æ¸…å•æ¨¡æ¿åº“ <span class="small">å¯ç¼–è¾‘</span></button>
      <button data-view="deliver"><span class="ico">ğŸ</span>çºªå¿µäº¤ä»˜åŒ… <span class="small">äº¤ä»˜</span></button>
      <button data-view="training"><span class="ico">ğŸ“</span>æœåŠ¡ä½“ç³»è®­ç»ƒè¥ <span class="small">å†…è®­</span></button>
      <button data-view="settings"><span class="ico">âš™ï¸</span>è®¾ç½®ä¸å¤‡ä»½ <span class="small">å¯¼å…¥å¯¼å‡º</span></button>
    </div>

    <div class="sep"></div>
    <div class="small">
      <div>âœ… è‡ªåŠ¨ä¿å­˜ï¼šLocalStorage</div>
      <div>â¬‡ å¯¼å‡ºï¼šJSON å¤‡ä»½</div>
      <div>ğŸ–¨ æ‰“å°ï¼šA4 / PDF</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="top-left">
        <button class="btn hamb" data-action="openSidebar">â˜° èœå•</button>
        <span class="pill" id="savePill">å·²ä¿å­˜</span>
        <span class="pill" id="currentClientPill">å½“å‰å®¢æˆ·ï¼šæœªé€‰æ‹©</span>
      </div>
      <div class="row">
        <button class="btn" data-action="print">ğŸ–¨ æ‰“å°å½“å‰é¡µ</button>
        <button class="btn primary" data-action="newClient">â• æ–°å»ºå®¢æˆ·</button>
      </div>
    </div>

    <!-- Views -->
    <section id="view-dashboard" class="grid cols3">
      <div class="card">
        <div class="hd"><h2>å®¢æˆ·æ€»è§ˆ</h2><span class="pill" id="kpiActive">è¿›è¡Œä¸­</span></div>
        <div class="bd">
          <div class="kpi"><div class="v" id="kpiClients">0</div><div class="muted">å®¢æˆ·æ•°é‡</div></div>
          <div class="sep"></div>
          <div class="kpi"><div class="v" id="kpiThisMonth">0</div><div class="muted">æœ¬æœˆæ¡£æœŸ</div></div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><h2>æ‰§è¡Œè¿›åº¦</h2><span class="pill">å¹³å‡å®Œæˆåº¦</span></div>
        <div class="bd">
          <div class="progress"><div class="bar" id="avgBar"></div></div>
          <div class="row" style="margin-top:10px">
            <span class="pill">å¹³å‡ï¼š<b id="avgPct">0%</b></span>
            <span class="pill">é€¾æœŸæé†’ï¼š<b id="overdueCount">0</b></span>
          </div>
          <div class="sep"></div>
          <div class="small">æç¤ºï¼šç»™å®¢æˆ·å¥—ç”¨æ¨¡æ¿åï¼Œé¡¹ç›®æ‰§è¡Œé¡µä¼šæ˜¾ç¤ºåˆ†é˜¶æ®µæ¸…å•ä¸è¿›åº¦æ¡ã€‚</div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><h2>å¿«æ·åŠ¨ä½œ</h2><span class="pill">ä¸€é”®å¥—ç”¨</span></div>
        <div class="bd">
          <div class="notice">
            <b>æ¨èå·¥ä½œæµ</b>
            <div class="small" style="margin-top:6px; line-height:1.6">
              â‘  å»ºå®¢æˆ· â†’ â‘¡ é€‰æ¨¡æ¿å¥—ç”¨ â†’ â‘¢ æŒ‰é˜¶æ®µæ‰“å‹¾æ‰§è¡Œ â†’ â‘£ è®°å½•å¤ç›˜ä¸é£é™© â†’ â‘¤ ç”Ÿæˆçºªå¿µäº¤ä»˜åŒ… â†’ â‘¥ å”®åå›è®¿
            </div>
          </div>
          <div class="sep"></div>
          <div class="row">
            <button class="btn" data-action="goto" data-view="clients">ğŸ‘¥ å»å®¢æˆ·åˆ—è¡¨</button>
            <button class="btn" data-action="goto" data-view="templates">ğŸ§© å»æ¨¡æ¿åº“</button>
            <button class="btn" data-action="goto" data-view="training">ğŸ“ å»è®­ç»ƒè¥</button>
          </div>
        </div>
      </div>
    </section>

    
    <section id="view-schedule" class="hidden">
      <div class="card">
        <div class="hd">
          <h2>æ¡£æœŸè®°å½•</h2>
          <div class="row">
            <button class="btn" data-action="scheduleMode" data-mode="calendar">ğŸ“… æ—¥å†</button>
            <button class="btn" data-action="scheduleMode" data-mode="month">ğŸ“‹ æœˆè®¢å•</button>
            <button class="btn" data-action="schedulePrev">â—€</button>
            <span class="pill" id="scheduleMonthLabel">â€”</span>
            <button class="btn" data-action="scheduleNext">â–¶</button>
            <button class="btn primary" data-action="scheduleAdd">â• æ·»åŠ å®¢æˆ·æ¡£æœŸ</button>
          </div>
        </div>
        <div class="bd">
          <div id="scheduleCalendar"></div>
          <div id="scheduleMonthList" class="hidden"></div>
          <div class="sep"></div>
          <div class="small muted">è¯´æ˜ï¼šæœ¬é¡µçš„â€œè®¢å•/æ¡£æœŸâ€æ¥è‡ªå®¢æˆ·æ¡£æ¡ˆä¸­çš„ã€æ¡£æœŸæ—¥æœŸã€‘å­—æ®µï¼›ç‚¹å‡»æ—¥æœŸå¯æŸ¥çœ‹å½“å¤©è®¢å•å¹¶å¿«é€Ÿæ–°å¢/ç¼–è¾‘ã€‚</div>
        </div>
      </div>
    </section>

    <!-- Day Modal -->
    <div class="hidden" id="dayModalWrap">
      <div class="overlay show" id="dayModalOverlay" data-action="closeDayModal"></div>
      <div id="dayModal" class="card" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(720px, 92vw); z-index:60">
        <div class="hd">
          <h2 id="dayModalTitle">â€”</h2>
          <div class="row">
            <button class="btn" data-action="printDayRun">ğŸ–¨ å½“å¤©æ‰§è¡Œå•ä¸€é”®æ‰“å°</button>
            <button class="btn primary" data-action="dayModalAdd">â• å½“å¤©æ–°å¢å®¢æˆ·</button>
            <button class="btn" data-action="closeDayModal">âœ• å…³é—­</button>
          </div>
        </div>
        <div class="bd" id="dayModalBody"></div>
      </div>
    </div>

    <section id="view-clients" class="hidden">
      <div class="grid cols2">
        <div class="card">
          <div class="hd">
            <h2>å®¢æˆ·åˆ—è¡¨</h2>
            <div class="row">
              <input id="clientSearch" placeholder="æœç´¢ï¼šå§“å / ç”µè¯ / å¤‡æ³¨" style="width:240px"/>
              <button class="btn" data-action="export">â¬‡ å¯¼å‡º</button>
              <button class="btn" data-action="import">â¬† å¯¼å…¥</button>
            </div>
          </div>
          <div class="bd">
            <div id="clientList"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><h2 id="clientFormTitle">æ–°å»º / ç¼–è¾‘å®¢æˆ·</h2><span class="pill">è‡ªåŠ¨ä¿å­˜</span></div>
          <div class="bd">
            <div class="formgrid">
              <div><label>å®¢æˆ·å§“å</label><input id="fName" placeholder="å¦‚ï¼šå¼ ä¸‰ & æå››"/></div>
              <div><label>æ¡£æœŸæ—¥æœŸ</label><input id="fDate" type="date"/></div>
              <div><label>ç”µè¯</label><input id="fPhone" placeholder=""/></div>
              <div><label>å¾®ä¿¡</label><input id="fWechat" placeholder=""/></div>
              <div><label>åŸå¸‚ / é…’åº—</label><input id="fCity" placeholder=""/></div>
              <div>
                <label>é¡¹ç›®çŠ¶æ€</label>
                <select id="fStatus">
                  <option value="in_progress">è¿›è¡Œä¸­</option>
                  <option value="booked">å·²å®šæ¡£</option>
                  <option value="completed">å·²å®Œæˆ</option>
                  <option value="paused">æš‚åœ</option>
                </select>
              </div>
            </div>

            <div class="sep"></div>

            <div class="formgrid">
              <div><label>å¥—é¤ / æœåŠ¡èŒƒå›´</label><input id="fPackage" placeholder="å¦‚ï¼šå…¨æ¡ˆç­–åˆ’ / è½»ç­–åˆ’ / å¸ä»ªç»Ÿç­¹ç­‰"/></div>
              <div><label>é¢„ç®—åŒºé—´</label><input id="fBudget" placeholder="å¦‚ï¼š3-5W"/></div>
            </div>

            <div style="margin-top:12px">
              <label>å¤‡æ³¨ï¼ˆå¯å†™ï¼šé£æ ¼åå¥½ / å®¶åº­å…³ç³» / ç‰¹æ®Šå®‰æ’ / é£é™©ç‚¹ï¼‰</label>
              <textarea id="fNotes" placeholder="å»ºè®®ç”¨ï¼šèƒŒæ™¯-è¯‰æ±‚-é™åˆ¶-å†³ç­–äºº-é£é™©-ä¸‹ä¸€æ­¥"></textarea>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn primary" data-action="saveClient">ğŸ’¾ ä¿å­˜å®¢æˆ·</button>
              <button class="btn" data-action="setCurrent">â­ è®¾ä¸ºå½“å‰å®¢æˆ·</button>
              <button class="btn danger" data-action="deleteClient">ğŸ—‘ åˆ é™¤</button>
              <button class="btn" data-action="goto" data-view="client">ğŸ§¾ å»é¡¹ç›®æ‰§è¡Œ</button>
            </div>

            <div class="sep"></div>
            <div class="notice">
              <b>å®¢æˆ·æ²Ÿé€šæ–¹æ³•èåˆï¼ˆä¸æ˜¾ç¤ºæ¥æºï¼‰</b>
              <div class="small" style="margin-top:6px; line-height:1.7">
                æœ¬ç³»ç»Ÿé»˜è®¤å°†â€œä¸‰å±‚æ²Ÿé€šâ€å†™è¿›æµç¨‹ï¼š<br/>
                â‘  ç¤ºèŒƒæ‹†è§£ï¼šç»™å‡ºå‚è€ƒæ ·ä¾‹ â†’ æ‹†è§£ç»“æ„ â†’ å¯¹ç…§ç»ƒä¹ ï¼›<br/>
                â‘¡ å¼•å¯¼å…±åˆ›ï¼šç”¨å¼€æ”¾æé—®è®©å®¢æˆ·è¯´å‡ºâ€œåŸå› ä¸ä¼˜å…ˆçº§â€ï¼Œå†åšå¤è¿°ç¡®è®¤ï¼›<br/>
                â‘¢ ä½“éªŒåŠ åˆ†ï¼šä¸ºå…³é”®èŠ‚ç‚¹è®¾è®¡ä¸€å¤„â€œè¶…é¢„æœŸå°æƒŠå–œâ€ï¼Œå¹¶æŠŠäº¤ä»˜ä»ªå¼æ„Ÿå†™è¿›æ¸…å•ã€‚
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <section id="view-client" class="hidden">
      <div class="grid cols2">
        <div class="card">
          <div class="hd"><h2>å½“å‰å®¢æˆ·ä¿¡æ¯</h2><span class="pill" id="clientMetaPill">æœªé€‰æ‹©</span></div>
          <div class="bd" id="clientMeta"></div>
        </div>
        <div class="card">
          <div class="hd"><h2>æ¸…å•å¥—ç”¨ä¸è¿›åº¦</h2><span class="pill">æŒ‰é˜¶æ®µæ‰§è¡Œ</span></div>
          <div class="bd">
            <div class="row">
              <select id="applyTemplateSelect" style="min-width:260px"></select>
              <button class="btn primary" data-action="applyTemplate">ğŸ§© å¥—ç”¨åˆ°å½“å‰å®¢æˆ·</button>
              <button class="btn" data-action="clearClientChecklists">ğŸ§¹ æ¸…ç©ºå®¢æˆ·æ¸…å•</button>
            </div>
            <div class="sep"></div>
            <div class="tabs" id="checklistTabs"></div>
            <div style="margin-top:10px" class="progress"><div class="bar" id="clientBar"></div></div>
            <div class="row" style="margin-top:10px">
              <span class="pill">å®Œæˆåº¦ï¼š<b id="clientPct">0%</b></span>
              <span class="pill">å·²å®Œæˆï¼š<b id="doneCount">0</b></span>
              <span class="pill">æœªå®Œæˆï¼š<b id="todoCount">0</b></span>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><h2>æ‰§è¡Œæ¸…å•ï¼ˆå¯å‹¾é€‰ / å¯ç¼–è¾‘ï¼‰</h2>
          <div class="row">
            <button class="btn" data-action="addChecklistRow">â• åŠ ä¸€è¡Œ</button>
            <button class="btn" data-action="exportClient">â¬‡ å¯¼å‡ºå½“å‰å®¢æˆ·ï¼ˆJSONï¼‰</button>
          </div>
        </div>
        <div class="bd">
          <div class="tableWrap">
            <table id="checklistTable"></table>
          </div>
          <div class="sep"></div>
          <div class="notice">
            <b>é£é™©ä¸å¤ç›˜ï¼ˆå»ºè®®æ¯æ¬¡æ²Ÿé€šå 3 åˆ†é’Ÿå¡«å†™ï¼‰</b>
            <div class="formgrid" style="margin-top:10px">
              <div>
                <label>æœ¬æ¬¡æ²Ÿé€šç»“è®ºï¼ˆå¤è¿°ç¡®è®¤ç”¨è¯­ï¼‰</label>
                <textarea id="briefConclusion" placeholder="å¦‚ï¼šä»Šå¤©ç¡®è®¤äº†â€¦â€¦ä¼˜å…ˆçº§æ˜¯â€¦â€¦æœ€ç»ˆç”±â€¦â€¦æ‹æ¿ã€‚"></textarea>
              </div>
              <div>
                <label>é£é™©ç‚¹ä¸åº”å¯¹ï¼ˆæå‰å†™è¿›æ‰§è¡Œï¼‰</label>
                <textarea id="briefRisks" placeholder="å¦‚ï¼šé•¿è¾ˆæ„è§ä¸ä¸€è‡´â†’ä¸‹æ¬¡ä¼šè®®è®©åŒæ–¹çˆ¶æ¯éƒ½åœ¨åœºï¼›é…’åº—ç¯å…‰ä¸ç¨³å®šâ†’å¤‡ç”¨ç¯+æœºä½é¢„æ¡ˆã€‚"></textarea>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-action="saveBrief">ğŸ’¾ ä¿å­˜å¤ç›˜</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-templates" class="hidden">
      <div class="grid cols2">
        <div class="card">
          <div class="hd"><h2>æ¨¡æ¿åˆ—è¡¨</h2><span class="pill" id="tplCount">0</span></div>
          <div class="bd">
            <div class="row">
              <input id="tplSearch" placeholder="æœç´¢æ¨¡æ¿åç§°" style="width:220px"/>
              <button class="btn" data-action="resetTemplates">â™» æ¢å¤é»˜è®¤æ¨¡æ¿</button>
            </div>
            <div class="sep"></div>
            <div id="tplList"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><h2 id="tplEditorTitle">æ¨¡æ¿ç¼–è¾‘å™¨</h2><span class="pill">ä¿å­˜å³ç”Ÿæ•ˆ</span></div>
          <div class="bd">
            <div class="row">
              <button class="btn" data-action="addTplRow">â• åŠ ä¸€è¡Œ</button>
              <button class="btn danger" data-action="deleteTpl">ğŸ—‘ åˆ é™¤æ¨¡æ¿</button>
              <button class="btn" data-action="duplicateTpl">ğŸ“„ å¤åˆ¶æ¨¡æ¿</button>
            </div>
            <div class="sep"></div>
            <div class="tableWrap">
              <table id="tplTable"></table>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><h2>å¦‚ä½•æŠŠæ¨¡æ¿å˜æˆâ€œå¯äº¤ä»˜çš„æœåŠ¡ä½“ç³»â€</h2><span class="pill">è®­ç»ƒè¥æ–¹æ³•</span></div>
        <div class="bd" style="line-height:1.75">
          <div class="small">
            ä½ å¯ä»¥æŠŠæ¯å¼ æ¨¡æ¿éƒ½æŒ‰â€œæœåŠ¡é—­ç¯â€å‡çº§ä¸ºï¼š<b>è§¦ç‚¹ â†’ äº§å‡º â†’ è¯æ® â†’ å¤ç›˜</b><br/>
            â€¢ è§¦ç‚¹ï¼šå®¢æˆ·ä»€ä¹ˆæ—¶å€™æ„ŸçŸ¥åˆ°ä½ åœ¨åšäº‹ï¼Ÿï¼ˆä¼šå‰ã€ä¼šä¸­ã€ä¼šåã€ç°åœºã€å”®åï¼‰<br/>
            â€¢ äº§å‡ºï¼šä½ äº¤ä»˜äº†ä»€ä¹ˆï¼Ÿï¼ˆæ¸…å•ã€è„šæœ¬ã€æ—¶é—´è½´ã€å›¾çº¸ã€å¤‡å¿˜ã€ç…§ç‰‡è§†é¢‘ã€å›è®¿ï¼‰<br/>
            â€¢ è¯æ®ï¼šè®©å®¢æˆ·â€œçœ‹è§â€è¿›åº¦ï¼ˆæˆªå›¾/æ–‡ä»¶/ç¡®è®¤è®°å½•/å¯¹è´¦å•/ç­¾å­—ï¼‰<br/>
            â€¢ å¤ç›˜ï¼šæ¯æ¬¡æ²Ÿé€š 3 åˆ†é’Ÿå†™ï¼šç»“è®º + é£é™© + ä¸‹ä¸€æ­¥
          </div>
        </div>
      </div>
    </section>

    <section id="view-deliver" class="hidden">
      <div class="grid cols2">
        <div class="card">
          <div class="hd"><h2>é€‰æ‹©å®¢æˆ·</h2><span class="pill">ç”Ÿæˆäº¤ä»˜åŒ…</span></div>
          <div class="bd">
            <select id="deliverClientSelect"></select>
            <div class="sep"></div>
            <div class="notice">
              <b>äº¤ä»˜åŒ…ç»“æ„ï¼ˆé»˜è®¤ï¼‰</b>
              <div class="small" style="margin-top:6px; line-height:1.7">
                â‘  çˆ±æƒ…æ•…äº‹æ‘˜è¦ï¼ˆå¯å¤è¿°/å¯åˆ†äº«ï¼‰<br/>
                â‘¡ å©šç¤¼å½“å¤©æ—¶é—´è½´ï¼ˆæœ€ç»ˆç‰ˆï¼‰<br/>
                â‘¢ å…³é”®é•œå¤´æ¸…å•ï¼ˆæ‘„å½±æ‘„åƒå¯¹æ¥ï¼‰<br/>
                â‘£ ç°åœºå½©æ’ä¸æ‰§è¡Œè¦ç‚¹ï¼ˆç»™å›¢é˜Ÿï¼‰<br/>
                â‘¤ çºªå¿µç‰©æ¸…å•ï¼ˆè¯ä¹¦/èª“è¯/åˆå½±/æƒŠå–œç‰©ä»¶ï¼‰<br/>
                â‘¥ å”®åå›è®¿ä¸é•¿æœŸå…³ç³»ï¼ˆçºªå¿µæ—¥æé†’/äºŒæ¬¡è½¬ä»‹ç»ï¼‰
              </div>
            </div>
            <div class="sep"></div>
            <button class="btn primary" data-action="generateDeliver">ğŸ ç”Ÿæˆé¢„è§ˆ</button>
            <button class="btn" data-action="print">ğŸ–¨ æ‰“å° / ä¿å­˜ä¸º PDF</button>
          </div>
        </div>

        <div class="card">
          <div class="hd"><h2>äº¤ä»˜åŒ…é¢„è§ˆï¼ˆå¯ç¼–è¾‘ï¼‰</h2><span class="pill">å¯ç›´æ¥å¤åˆ¶</span></div>
          <div class="bd">
            <label>äº¤ä»˜åŒ…å†…å®¹</label>
            <textarea id="deliverText" placeholder="ç‚¹å‡»â€œç”Ÿæˆé¢„è§ˆâ€åè‡ªåŠ¨å¡«å……ï¼Œä½ å¯ä»¥å†æ¶¦è‰²æˆé«˜å®šç‰ˆæœ¬ã€‚"></textarea>
            <div class="sep"></div>
            <div class="row">
              <button class="btn" data-action="copyDeliver">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
              <button class="btn" data-action="saveDeliver">ğŸ’¾ ä¿å­˜åˆ°å®¢æˆ·æ¡£æ¡ˆ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hd"><h2>ä½“éªŒåŠ åˆ†æ¸…å•ï¼ˆè®©å®¢æˆ·ä¸»åŠ¨è½¬ä»‹ç»ï¼‰</h2><span class="pill">é»˜è®¤å†…ç½®</span></div>
        <div class="bd">
          <div class="row">
            <span class="tag">ä¼šå‰ï¼šä¸€é¡µå¼â€œç¡®è®¤æ¸…å•â€</span>
            <span class="tag">ä¼šåï¼šä¼šè®®çºªè¦ 10 åˆ†é’Ÿå†…å‘å‡º</span>
            <span class="tag">ç°åœºï¼šå¤‡ç”¨é¢„æ¡ˆå¯è§†åŒ–</span>
            <span class="tag">äº¤ä»˜ï¼šä»ªå¼æ„ŸåŒ…è£…</span>
            <span class="tag">å”®åï¼šçºªå¿µæ—¥æé†’</span>
          </div>
          <div class="sep"></div>
          <div class="small" style="line-height:1.7">
            å…³é”®åŸåˆ™ï¼šè®©å®¢æˆ·æ¯ä¸ªé˜¶æ®µéƒ½èƒ½â€œçœ‹è§ä½ åœ¨äº¤ä»˜â€ã€‚æŠŠæƒŠå–œåšæˆå¯æ ‡å‡†åŒ–çš„åŠ¨ä½œï¼ˆå¯å¤åˆ¶ã€å¯è¢«å›¢é˜Ÿæ‰§è¡Œï¼‰ã€‚
          </div>
        </div>
      </div>
    </section>

    <section id="view-training" class="hidden">
      <div class="card">
        <div class="hd"><h2>æœåŠ¡ä½“ç³»è®­ç»ƒè¥ï¼ˆå†…ç½®è¯¾ç¨‹ï¼‰</h2><span class="pill">ç¤ºèŒƒæ‹†è§£ + å¼•å¯¼å…±åˆ› + ä½“éªŒåŠ åˆ†</span></div>
        <div class="bd" id="trainingContent"></div>
      </div>
    </section>

    <section id="view-settings" class="hidden">
      <div class="grid cols2">
        <div class="card">
          <div class="hd"><h2>å¤–è§‚ä¸åå¥½</h2><span class="pill">å³æ—¶ç”Ÿæ•ˆ</span></div>
          <div class="bd">
            <div class="row">
              <button class="btn" data-action="toggleTheme">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
              <button class="btn" data-action="wipeAll">ğŸ§¹ æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
            </div>
            <div class="sep"></div>
            <label>ä½ çš„å“ç‰Œåï¼ˆæ˜¾ç¤ºåœ¨æ‰“å°é¡µé¡¶éƒ¨ï¼‰</label>
            <input id="brandName" placeholder="å¦‚ï¼šå™è¿°å©šç¤¼ Narrate Wedding Studio"/>
            <div class="sep"></div>
            <button class="btn primary" data-action="saveSettings">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            <div class="sep"></div>
            <div class="small">æç¤ºï¼šæœ¬é¡µçš„â€œæ¸…ç©ºæœ¬åœ°æ•°æ®â€ä¸å¯æ¢å¤ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚</div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><h2>å¤‡ä»½ä¸è¿ç§»</h2><span class="pill">JSON</span></div>
          <div class="bd">
            <div class="notice">
              <b>è·¨ç”µè„‘/æ¡Œé¢ç«¯è¿ç§»</b>
              <div class="small" style="margin-top:6px; line-height:1.7">
                â‘  å¯¼å‡º JSON â†’ â‘¡ åœ¨æ–°è®¾å¤‡æ‰“å¼€åŒä¸€ HTML â†’ â‘¢ å¯¼å…¥ JSON å³å¯æ¢å¤å…¨éƒ¨å®¢æˆ·ã€æ¸…å•å‹¾é€‰çŠ¶æ€ã€äº¤ä»˜åŒ…ä¸å¤ç›˜å†…å®¹ã€‚
              </div>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button class="btn primary" data-action="export">â¬‡ å¯¼å‡ºå…¨é‡å¤‡ä»½</button>
              <button class="btn" data-action="import">â¬† å¯¼å…¥å¤‡ä»½</button>
              <button class="btn" data-action="downloadHTML">ğŸ’¾ å¦å­˜æœ¬ HTML</button>
            </div>
            <input id="fileInput" type="file" accept="application/json" class="hidden"/>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<div id="printArea" class="hidden"></div>

<div class="toast" id="toast"></div>

<!-- Embedded template data -->
<script id="templatesData" type="application/json">{"å®¢æˆ·å¯¹æ¥æ¸…å•å…¨é“¾è·¯": {"key": "å®¢æˆ·å¯¹æ¥æ¸…å•å…¨é“¾è·¯", "name": "å®¢æˆ·å¯¹æ¥æ¸…å•ï¼ˆå…¨é“¾è·¯ï¼‰", "fields": ["é˜¶æ®µ/è§¦ç‚¹", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰", "å†…éƒ¨è®°å½•å­—æ®µ"], "rows": [{"é˜¶æ®µ/è§¦ç‚¹": "å’¨è¯¢-10min", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "ä¸‰è¦ç´ æ”¶é›†+é¢„çº¦è¯Šæ–­", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "è¯Šæ–­é¢„çº¦ç¡®è®¤", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "æ—¶é—´äºŒé€‰ä¸€", "å†…éƒ¨è®°å½•å­—æ®µ": "çº¿ç´¢å¡ï¼šé¢„ç®—/åœºåœ°/å†³ç­–äºº", "_id": "8a64c77ccf", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "è¯Šæ–­-10min", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "ä¸‰é—®ä¸‰ç»™ï¼ˆé£é™©/æµç¨‹/ä¸‹ä¸€æ­¥ï¼‰", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "é£é™©é›·è¾¾è‰ç¨¿ï¼ˆæˆªå›¾ï¼‰", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "æ˜¯å¦è¿›å…¥æ·±è®¿ï¼ˆæ˜¯/å¦ï¼‰", "å†…éƒ¨è®°å½•å­—æ®µ": "é£é™©Top1+è§¦å‘æ¡ä»¶", "_id": "f2316fd6ae", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "æ·±è®¿-60min", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "æ•…äº‹/çˆ¶æ¯/ç¦åŒº/æ¥å®¾ç”»åƒ", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "ä¸‰å…³é”®è¯+ç¦åŒºæ¸…å•", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "æ‹æ¿æ—¶é—´ç‚¹", "å†…éƒ¨è®°å½•å­—æ®µ": "æ·±è®¿è¡¨+çˆ¶æ¯è¯‰æ±‚", "_id": "a34d9fd013", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "ææ¡ˆ-24h", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "ä¸€é¡µçº¸ææ¡ˆï¼ˆæ–¹å‘+é£é™©+ä¸‰æ¡£ï¼‰", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "ä¸€é¡µçº¸ææ¡ˆæˆªå›¾", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "æ–¹å‘A/Bé€‰æ‹©", "å†…éƒ¨è®°å½•å­—æ®µ": "ææ¡ˆåé¦ˆ+å¼‚è®®ç±»å‹", "_id": "ccf3762205", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "ç­¾çº¦-24h", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "å»ºç¾¤+ç¾¤è§„+èŠ‚ç‚¹è¡¨", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "äº¤ä»˜èŠ‚ç‚¹è¡¨+è”ç³»äººå¡", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "Aæ˜¯è°ï¼ˆæ‹æ¿äººï¼‰", "å†…éƒ¨è®°å½•å­—æ®µ": "é¡¹ç›®çœ‹æ¿M0å®Œæˆ", "_id": "49aafe6def", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "D-30", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "äº”æ–¹åä½œä¼š1", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "æµç¨‹ç¡®è®¤å•v2+RACI", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "æœºä½/ä¸Šèœ/è¶…æ—¶å£å¾„", "å†…éƒ¨è®°å½•å­—æ®µ": "ä¼šè®®çºªè¦+å¾…åŠ", "_id": "f9bed57402", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "D-7", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "ç°åœºå½©æ’+åˆ‡æ¢æ¼”ç»ƒ", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "å£ä»¤å¡+å½©æ’çºªè¦", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "åˆ‡æ¢æ–¹æ¡ˆå¯æ‰§è¡Œç¡®è®¤", "å†…éƒ¨è®°å½•å­—æ®µ": "é£é™©é¢„æ¡ˆæ›´æ–°æ—¥æœŸ", "_id": "6249726e9e", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "D+1", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "æ„Ÿè°¢+äº¤ä»˜èŠ‚å¥ç¡®è®¤", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "å½±åƒäº¤ä»˜æ—¶é—´è¡¨", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "äº¤ä»˜èŠ‚ç‚¹ç¡®è®¤", "å†…éƒ¨è®°å½•å­—æ®µ": "å”®åçœ‹æ¿D+1å®Œæˆ", "_id": "a8913b3249", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "D+7", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "å£ç¢‘å…±åˆ›1", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "å¯è½¬å‘ç´ æåŒ…1", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "æ„¿æ„å‘/ä¸å‘", "å†…éƒ¨è®°å½•å­—æ®µ": "å£ç¢‘åŠ¨ä½œè®°å½•", "_id": "be9896d627", "_done": false}, {"é˜¶æ®µ/è§¦ç‚¹": "D+30", "åŠ¨ä½œï¼ˆä½ è¦åšä»€ä¹ˆï¼‰": "çºªå¿µäº¤ä»˜+è½¬ä»‹ç»é“ºå«", "è¯æ®/äº¤ä»˜ï¼ˆå®¢æˆ·å¯è§ï¼‰": "é«˜å®šçºªå¿µå†Œ+ä¸€å‘¨å¹´æ¸…å•", "ç¡®è®¤ç‚¹ï¼ˆé€‰æ‹©é¢˜/ç­¾å­—ï¼‰": "è½¬ä»‹ç»å·¥å…·å¡", "å†…éƒ¨è®°å½•å­—æ®µ": "è½¬ä»‹ç»çº¿ç´¢å›æ”¶", "_id": "c85b3902ad", "_done": false}]}, "äº”æ–¹ååŒæ¸…å•D30": {"key": "äº”æ–¹ååŒæ¸…å•D30", "name": "äº”æ–¹ååŒæ¸…å•ï¼ˆD-30ï¼‰", "fields": ["è§’è‰²", "ä¼šå‰å‡†å¤‡ï¼ˆå‘ç¾¤ï¼‰", "ä¼šä¸­å¿…é¡»ç¡®è®¤", "ä¼šåå¿…é¡»äº¤ä»˜"], "rows": [{"è§’è‰²": "ä¸»æŒ", "ä¼šå‰å‡†å¤‡ï¼ˆå‘ç¾¤ï¼‰": "çˆ¶æ¯ç¯èŠ‚å£å¾„+èª“è¯è®­ç»ƒå¡", "ä¼šä¸­å¿…é¡»ç¡®è®¤": "çˆ¶æ¯ç¯èŠ‚æ—¶é•¿ä¸è¾¹ç•Œ", "ä¼šåå¿…é¡»äº¤ä»˜": "è„šæœ¬v1ï¼ˆD-21ï¼‰", "_id": "297427821c", "_done": false}, {"è§’è‰²": "ç­–åˆ’", "ä¼šå‰å‡†å¤‡ï¼ˆå‘ç¾¤ï¼‰": "é£æ ¼æ–¹å‘+ç‰©æ–™æ¸…å•è‰æ¡ˆ", "ä¼šä¸­å¿…é¡»ç¡®è®¤": "åŠ¨çº¿æ˜¯å¦å½±å“å¸ƒç½®/æ‹æ‘„", "ä¼šåå¿…é¡»äº¤ä»˜": "ç‰©æ–™æ¸…å•æ›´æ–°ï¼ˆD-25ï¼‰", "_id": "70d5f0b84c", "_done": false}, {"è§’è‰²": "æ€»æ§", "ä¼šå‰å‡†å¤‡ï¼ˆå‘ç¾¤ï¼‰": "æµç¨‹éª¨æ¶v2+é£é™©é›·è¾¾", "ä¼šä¸­å¿…é¡»ç¡®è®¤": "Top3é£é™©åˆ‡æ¢å£ä»¤&è´Ÿè´£äºº", "ä¼šåå¿…é¡»äº¤ä»˜": "ä¼šè®®çºªè¦+å¾…åŠï¼ˆ24hï¼‰", "_id": "d7f748c989", "_done": false}, {"è§’è‰²": "æ‘„å½±æ‘„åƒ", "ä¼šå‰å‡†å¤‡ï¼ˆå‘ç¾¤ï¼‰": "æœºä½éœ€æ±‚+äº¤ä»˜æ¸…å•", "ä¼šä¸­å¿…é¡»ç¡®è®¤": "æœºä½å¯å®ç°/ç¯å…‰æ˜¯å¦å¤Ÿ", "ä¼šåå¿…é¡»äº¤ä»˜": "æœºä½æœ€ç»ˆç‰ˆï¼ˆD-20ï¼‰", "_id": "4ed311ec5b", "_done": false}, {"è§’è‰²": "é…’åº—", "ä¼šå‰å‡†å¤‡ï¼ˆå‘ç¾¤ï¼‰": "å…ä½/ä¸Šèœ/è¶…æ—¶/æ¢å…å£å¾„", "ä¼šä¸­å¿…é¡»ç¡®è®¤": "è¶…æ—¶è´¹ä¸æ¢å…æ¡ä»¶", "ä¼šåå¿…é¡»äº¤ä»˜": "ç¯å…‰éŸ³å“é…ç½®å•ï¼ˆD-25ï¼‰", "_id": "1598723905", "_done": false}]}, "é…’åº—å¯¹æ¥æ¸…å•": {"key": "é…’åº—å¯¹æ¥æ¸…å•", "name": "é…’åº—å¯¹æ¥æ¸…å•", "fields": ["æ¨¡å—", "å¿…é¡»é—®åˆ°çš„å£å¾„", "è¯æ®/æˆªå›¾", "é£é™©ä¸é¢„æ¡ˆ"], "rows": [{"æ¨¡å—": "å…ä½/æ¢å…", "å¿…é¡»é—®åˆ°çš„å£å¾„": "æ˜¯å¦å¯èƒ½æ¢å…ï¼Ÿè§¦å‘æ¡ä»¶ï¼Ÿæå‰å¤šä¹…é€šçŸ¥ï¼Ÿ", "è¯æ®/æˆªå›¾": "è´Ÿè´£äººç¡®è®¤æˆªå›¾", "é£é™©ä¸é¢„æ¡ˆ": "é¢„æ¡ˆï¼šå¤‡ç”¨å…ä½/åˆ‡æ¢æ—¶é—´è½´", "_id": "a13b86eb6f", "_done": false}, {"æ¨¡å—": "éŸ³å“/è¯ç­’", "å¿…é¡»é—®åˆ°çš„å£å¾„": "è¯ç­’æ•°é‡ï¼Ÿç”µæ± ï¼Ÿå¤‡ç”¨è¯ç­’ï¼Ÿéº¦å…‹é£ç±»å‹ï¼Ÿ", "è¯æ®/æˆªå›¾": "è®¾å¤‡æ¸…å•æˆªå›¾", "é£é™©ä¸é¢„æ¡ˆ": "é¢„æ¡ˆï¼šè‡ªå¸¦å¤‡ä»½/åŒè¯ç­’", "_id": "3754111010", "_done": false}, {"æ¨¡å—": "ç¯å…‰", "å¿…é¡»é—®åˆ°çš„å£å¾„": "ç¯å…‰æ˜¯å¦å¯æ§ï¼Ÿè°æ§ï¼Ÿæ˜¯å¦å¯å•ç‚¹è¿½å…‰ï¼Ÿ", "è¯æ®/æˆªå›¾": "æ§å°è”ç³»äºº", "é£é™©ä¸é¢„æ¡ˆ": "é¢„æ¡ˆï¼šå…³é”®ç¯èŠ‚è¡¥å…‰ç¯", "_id": "b0e6555e04", "_done": false}, {"æ¨¡å—": "ä¸ŠèœèŠ‚å¥", "å¿…é¡»é—®åˆ°çš„å£å¾„": "æ•¬é…’å¼€å§‹/æš‚åœä¸Šèœç‚¹/åŠ èœè§„åˆ™", "è¯æ®/æˆªå›¾": "æµç¨‹å£å¾„æˆªå›¾", "é£é™©ä¸é¢„æ¡ˆ": "é¢„æ¡ˆï¼šè°ƒæ•´èŠ‚ç›®/å»¶åæ•¬é…’", "_id": "b98ee36411", "_done": false}, {"æ¨¡å—": "è¶…æ—¶è´¹", "å¿…é¡»é—®åˆ°çš„å£å¾„": "è¶…æ—¶è®¡è´¹æ ‡å‡†ï¼Ÿæœ€å°å•ä½ï¼Ÿè°ç­¾å­—ï¼Ÿ", "è¯æ®/æˆªå›¾": "è´¹ç”¨å£å¾„æˆªå›¾", "é£é™©ä¸é¢„æ¡ˆ": "é¢„æ¡ˆï¼šæ”¶å£ç­–ç•¥/åˆ‡æ¢æ–¹æ¡ˆ", "_id": "a5a7bebdf4", "_done": false}, {"æ¨¡å—": "ç”µæº/èµ°çº¿", "å¿…é¡»é—®åˆ°çš„å£å¾„": "ç”µæºä½ç½®/èµ°çº¿é™åˆ¶/æ˜¯å¦å¯èµ°åœ°æ¯¯ä¸‹", "è¯æ®/æˆªå›¾": "ç”µæºç‚¹ä½å›¾", "é£é™©ä¸é¢„æ¡ˆ": "é¢„æ¡ˆï¼šè‡ªå¸¦çº¿æ/åœ°è´´", "_id": "7ba9af937f", "_done": false}]}, "æ‘„å½±æ‘„åƒå¯¹æ¥æ¸…å•": {"key": "æ‘„å½±æ‘„åƒå¯¹æ¥æ¸…å•", "name": "æ‘„å½±æ‘„åƒå¯¹æ¥æ¸…å•", "fields": ["æ¨¡å—", "è¦ç¡®è®¤çš„ç‚¹", "äº¤ä»˜è¯æ®", "å¤‡æ³¨"], "rows": [{"æ¨¡å—": "æœºä½", "è¦ç¡®è®¤çš„ç‚¹": "ä¸»æœºä½/å‰¯æœºä½/æ‘‡è‡‚/æ— äººæœºæ˜¯å¦å…è®¸", "äº¤ä»˜è¯æ®": "æœºä½è¡¨æœ€ç»ˆç‰ˆ", "å¤‡æ³¨": "èµ°ä½é¿å…æŒ¡é•œå¤´", "_id": "570ffe104e", "_done": false}, {"æ¨¡å—": "æ”¶éŸ³", "è¦ç¡®è®¤çš„ç‚¹": "èª“è¯æ”¶éŸ³æ–¹æ¡ˆï¼ˆé¢†å¤¹/å½•éŸ³ç¬”/è°ƒéŸ³å°ï¼‰", "äº¤ä»˜è¯æ®": "æ”¶éŸ³æ–¹æ¡ˆç¡®è®¤", "å¤‡æ³¨": "å¿…é¡»æœ‰å¤‡ä»½", "_id": "cae6032a59", "_done": false}, {"æ¨¡å—": "å…³é”®æƒ…ç»ªç‚¹", "è¦ç¡®è®¤çš„ç‚¹": "çˆ¶æ¯ç¯èŠ‚/èª“è¯/æ‹¥æŠ±/åˆå½±/æ•¬é…’", "äº¤ä»˜è¯æ®": "æ‹æ‘„é‡ç‚¹æ¸…å•", "å¤‡æ³¨": "æå‰ç»™ä¸»æŒå£ä»¤", "_id": "8aeb278ab4", "_done": false}, {"æ¨¡å—": "äº¤ä»˜ç‰©", "è¦ç¡®è®¤çš„ç‚¹": "ç²¾ä¿®æ•°é‡/æˆç‰‡ç±»å‹/æ—¶é•¿/èŠ‚ç‚¹", "äº¤ä»˜è¯æ®": "äº¤ä»˜æ¸…å•+èŠ‚ç‚¹", "å¤‡æ³¨": "é€‰ç‰‡/ä¿®ç‰‡è§„åˆ™", "_id": "87f60998c6", "_done": false}, {"æ¨¡å—": "ç´ æå›æ”¶", "è¦ç¡®è®¤çš„ç‚¹": "ç¥ç¦/èŠ±çµ®/å½©æ’ç´ æ", "äº¤ä»˜è¯æ®": "ç´ æå›æ”¶æ¸…å•", "å¤‡æ³¨": "ç”¨äºçºªå¿µå†Œä¸å£ç¢‘", "_id": "5249b60fe4", "_done": false}]}, "å©šç¤¼å½“å¤©æ€»æ§æ¸…å•": {"key": "å©šç¤¼å½“å¤©æ€»æ§æ¸…å•", "name": "å©šç¤¼å½“å¤©æ€»æ§æ¸…å•", "fields": ["æ—¶ç‚¹", "æ€»æ§åŠ¨ä½œ", "å£ä»¤/åä½œè¦ç‚¹", "å¿…é¡»ç•™ç—•"], "rows": [{"æ—¶ç‚¹": "æ™¨ä¼š-60min", "æ€»æ§åŠ¨ä½œ": "ç‚¹å+è®¾å¤‡æ£€æŸ¥+åŠ¨çº¿å¤æ ¸", "å£ä»¤/åä½œè¦ç‚¹": "æ˜ç¡®åˆ‡æ¢å£ä»¤ä¸è´Ÿè´£äºº", "å¿…é¡»ç•™ç—•": "æ™¨ä¼šçºªè¦ï¼ˆç¾¤å†…ï¼‰", "_id": "88cb1747cf", "_done": false}, {"æ—¶ç‚¹": "è¿å®¾", "æ€»æ§åŠ¨ä½œ": "éŸ³ä¹/ç¯å…‰/èµ°ä½", "å£ä»¤/åä½œè¦ç‚¹": "ä¸»æŒ/æ‘„å½±/é…’åº—åŒæ­¥", "å¿…é¡»ç•™ç—•": "è¿å®¾é—®é¢˜è®°å½•", "_id": "a3673538b6", "_done": false}, {"æ—¶ç‚¹": "ä»ªå¼", "æ€»æ§åŠ¨ä½œ": "æŒ‰æ—¶é—´è½´æ¨è¿›+ç¼“å†²ä½", "å£ä»¤/åä½œè¦ç‚¹": "ç¯å…‰/éŸ³ä¹å£ä»¤ç»Ÿä¸€", "å¿…é¡»ç•™ç—•": "å…³é”®èŠ‚ç‚¹æ—¶é—´è®°å½•", "_id": "9ef9ee5c37", "_done": false}, {"æ—¶ç‚¹": "åˆå½±", "æ€»æ§åŠ¨ä½œ": "åˆå½±é¡ºåºä¸åŠ¨çº¿", "å£ä»¤/åä½œè¦ç‚¹": "æ‘„å½±æŒ‡æŒ¥+é…’åº—é…åˆ", "å¿…é¡»ç•™ç—•": "åˆå½±å®Œæˆç¡®è®¤", "_id": "c06a36ea66", "_done": false}, {"æ—¶ç‚¹": "æ™šå®´/æ•¬é…’", "æ€»æ§åŠ¨ä½œ": "ä¸ŠèœèŠ‚å¥+èŠ‚ç›®æ—¶é•¿", "å£ä»¤/åä½œè¦ç‚¹": "é…’åº—å£å¾„æ‰§è¡Œ", "å¿…é¡»ç•™ç—•": "è¶…æ—¶é¢„è­¦", "_id": "80dd69e4e3", "_done": false}, {"æ—¶ç‚¹": "æ”¶å£", "æ€»æ§åŠ¨ä½œ": "æ¸…ç‚¹ç‰©æ–™+ç´ æå›æ”¶", "å£ä»¤/åä½œè¦ç‚¹": "æ‘„å½±æ‘„åƒäº¤æ¥", "å¿…é¡»ç•™ç—•": "äº¤ä»˜èŠ‚ç‚¹ç¡®è®¤", "_id": "b01a776ccc", "_done": false}]}, "å®¢æˆ·çºªå¿µäº¤ä»˜åŒ…æ¸…å•": {"key": "å®¢æˆ·çºªå¿µäº¤ä»˜åŒ…æ¸…å•", "name": "å®¢æˆ·çºªå¿µäº¤ä»˜åŒ…æ¸…å•", "fields": ["äº¤ä»˜ç‰ˆæœ¬", "äº¤ä»˜æ—¶é—´", "æ¨¡å—", "å†…å®¹è¦ç‚¹", "ç´ ææ¥æº", "è´Ÿè´£äºº"], "rows": [{"äº¤ä»˜ç‰ˆæœ¬": "ç¬¬ä¸€ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+7", "æ¨¡å—": "å°é¢ä¿¡æ¯", "å†…å®¹è¦ç‚¹": "æ–°äºº/æ—¥æœŸ/åœ°ç‚¹/ä¸‰å…³é”®è¯/ä¸»è§†è§‰ç…§ç‰‡", "ç´ ææ¥æº": "å®¢æˆ·ç…§ç‰‡", "è´Ÿè´£äºº": "å”®å", "_id": "e24e959cda", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "ç¬¬ä¸€ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+7", "æ¨¡å—": "æ—¶é—´è½´çºªå¿µç‰ˆ", "å†…å®¹è¦ç‚¹": "å…³é”®èŠ‚ç‚¹æ—¶é—´çº¿+ç¼“å†²ä½", "ç´ ææ¥æº": "æ€»æ§æµç¨‹", "è´Ÿè´£äºº": "æ€»æ§", "_id": "83235a52bc", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "ç¬¬ä¸€ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+7", "æ¨¡å—": "èª“è¯&è‡´è¾", "å†…å®¹è¦ç‚¹": "èª“è¯/çˆ¶æ¯è‡´è¾/è¯å©šè¯", "ç´ ææ¥æº": "ä¸»æŒç¨¿/å½•éŸ³", "è´Ÿè´£äºº": "ä¸»æŒ", "_id": "53960a237b", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "ç¬¬ä¸€ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+7", "æ¨¡å—": "ç¥ç¦å¢™", "å†…å®¹è¦ç‚¹": "ç²¾é€‰ç¥ç¦10-20æ¡", "ç´ ææ¥æº": "ç°åœºç´ æ", "è´Ÿè´£äºº": "æ‘„å½±æ‘„åƒ", "_id": "1600a5a1ca", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "å®Œæ•´ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+30", "æ¨¡å—": "é«˜å…‰ç¬é—´", "å†…å®¹è¦ç‚¹": "ä¹å®«æ ¼ç…§ç‰‡+ä¸‰æ®µå›å¿†", "ç´ ææ¥æº": "æˆç‰‡/ç…§ç‰‡", "è´Ÿè´£äºº": "æ‘„å½±æ‘„åƒ", "_id": "ce2d512ce7", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "å®Œæ•´ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+30", "æ¨¡å—": "ä¾›åº”å•†è‡´è°¢", "å†…å®¹è¦ç‚¹": "äº”æ–¹åå•+æ„Ÿè°¢æ–‡æ¡ˆ", "ç´ ææ¥æº": "è”ç³»äººå¡", "è´Ÿè´£äºº": "æ€»æ§", "_id": "0bb3533584", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "å®Œæ•´ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+30", "æ¨¡å—": "ä¸€å‘¨å¹´æ¸…å•", "å†…å®¹è¦ç‚¹": "çºªå¿µæ—¥æé†’/ç…§ç‰‡æ•´ç†/å¤ç›˜", "ç´ ææ¥æº": "æ¨¡æ¿åº“", "è´Ÿè´£äºº": "å”®å", "_id": "aaad87aaa3", "_done": false}, {"äº¤ä»˜ç‰ˆæœ¬": "å®Œæ•´ç‰ˆ", "äº¤ä»˜æ—¶é—´": "D+30", "æ¨¡å—": "äºŒç»´ç ä½", "å†…å®¹è¦ç‚¹": "ç›¸å†Œ/è§†é¢‘é“¾æ¥äºŒç»´ç ï¼ˆå ä½ï¼‰", "ç´ ææ¥æº": "äº‘ç›˜é“¾æ¥", "è´Ÿè´£äºº": "å”®å", "_id": "674cb41f93", "_done": false}]}}</script>

<script>
(function(){
  // ---- utilities ----
  const $ = (s, el=document)=> el.querySelector(s);
  const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
  const uid = ()=> Math.random().toString(16).slice(2,10);
  const todayStr = ()=> new Date().toISOString().slice(0,10);
  const fmtDate = (d)=> d ? new Date(d).toLocaleDateString('zh-CN') : 'â€”';

  function toast(title, msg){
    const box = $('#toast');
    const node = document.createElement('div');
    node.className = 't';
    node.innerHTML = `<b>${escapeHtml(title)}</b><div class="small">${escapeHtml(msg||'')}</div>`;
    box.appendChild(node);
    setTimeout(()=>{ node.style.opacity='0'; node.style.transform='translateY(6px)'; node.style.transition='all .2s'; }, 2400);
    setTimeout(()=> node.remove(), 2900);
  }

  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function dl(filename, text, mime='text/plain'){
    const blob = new Blob([text], {type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  // ---- storage ----
  const KEY = 'narrate_wedding_exec_v1';
  const DEFAULT_TEMPLATES = JSON.parse($('#templatesData').textContent || '{}');

  const defaultState = {
    settings: { theme:'dark', brandName:'å™è¿°å©šç¤¼ï½œæœåŠ¡äº¤ä»˜' },
    templates: DEFAULT_TEMPLATES,
    clients: [],
    currentClientId: null
  };

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return structuredClone(defaultState);
      const s = JSON.parse(raw);
      // merge-safe
      return {
        ...structuredClone(defaultState),
        ...s,
        settings: {...defaultState.settings, ...(s.settings||{})},
        templates: s.templates && Object.keys(s.templates).length ? s.templates : structuredClone(DEFAULT_TEMPLATES),
        clients: Array.isArray(s.clients)? s.clients : [],
      };
    }catch(e){
      console.error(e);
      return structuredClone(defaultState);
    }
  }
  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
    $('#savePill').textContent = 'å·²ä¿å­˜';
    setTimeout(()=> $('#savePill').textContent = 'å·²ä¿å­˜', 600);
  }
  let state = load();

  // ---- theme ----
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.settings.theme || 'dark');
    $('#brandName').value = state.settings.brandName || '';
  }
  applyTheme();

  // ---- navigation / responsive sidebar ----
  const sidebar = $('#sidebar');
  const overlay = $('#overlay');
  function openSidebar(){ sidebar.classList.add('show'); overlay.classList.add('show'); }
  function closeSidebar(){ sidebar.classList.remove('show'); overlay.classList.remove('show'); }
  function showView(view){
    $$('main section[id^="view-"]').forEach(s=> s.classList.add('hidden'));
    $('#view-'+view).classList.remove('hidden');
    $$('#nav button').forEach(b=> b.classList.toggle('active', b.dataset.view===view));
    if(window.matchMedia('(max-width: 980px)').matches) closeSidebar();
    renderAll();
  }

  // ---- clients helpers ----
  function getClient(id){ return state.clients.find(c=> c.id===id) || null; }
  function currentClient(){ return getClient(state.currentClientId) || null; }

  function ensureClient(){
    const c = currentClient();
    if(!c){
      toast('æœªé€‰æ‹©å®¢æˆ·', 'è¯·å…ˆåœ¨â€œå®¢æˆ·æ¡£æ¡ˆâ€é‡Œè®¾ä¸ºå½“å‰å®¢æˆ·ã€‚');
      showView('clients');
      return null;
    }
    return c;
  }

  function setCurrentClient(id){
    state.currentClientId = id;
    save();
    renderHeader();
  }

  // ---- render header ----
  function renderHeader(){
    const c = currentClient();
    $('#currentClientPill').textContent = 'å½“å‰å®¢æˆ·ï¼š' + (c ? c.name : 'æœªé€‰æ‹©');
  }

  // ---- dashboard ----
  function avgProgress(){
    const clients = state.clients;
    if(!clients.length) return 0;
    let sum=0;
    for(const c of clients){
      sum += clientProgress(c).pct;
    }
    return Math.round(sum / clients.length);
  }

  function clientProgress(client){
    const lists = client.checklists || {};
    let total=0, done=0;
    for(const k in lists){
      const rows = lists[k] || [];
      for(const r of rows){
        total++;
        if(r._done) done++;
      }
    }
    const pct = total ? Math.round(done*100/total) : 0;
    return {total, done, pct};
  }

  function renderDashboard(){
    $('#kpiClients').textContent = state.clients.length;
    const now = new Date();
    const ym = now.toISOString().slice(0,7);
    const monthCount = state.clients.filter(c=> (c.date||'').slice(0,7)===ym).length;
    $('#kpiThisMonth').textContent = monthCount;

    const avg = avgProgress();
    $('#avgPct').textContent = avg + '%';
    $('#avgBar').style.width = avg + '%';

    // overdue: date passed and not completed
    const overdue = state.clients.filter(c=>{
      if(!c.date) return false;
      const d = new Date(c.date+'T00:00:00');
      return d < new Date(now.toISOString().slice(0,10)+'T00:00:00') && c.status!=='completed';
    }).length;
    $('#overdueCount').textContent = overdue;

    const active = state.clients.filter(c=> c.status==='in_progress' || c.status==='booked').length;
    $('#kpiActive').textContent = `è¿›è¡Œä¸­ï¼š${active}`;
  }

  // ---- clients list + form ----
  let editingClientId = null;

  function renderClientList(){
    const q = ($('#clientSearch').value || '').trim().toLowerCase();
    const wrap = $('#clientList');
    wrap.innerHTML = '';

    const arr = [...state.clients].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    const filtered = q ? arr.filter(c=>{
      const blob = `${c.name||''} ${c.phone||''} ${c.notes||''}`.toLowerCase();
      return blob.includes(q);
    }) : arr;

    if(!filtered.length){
      wrap.innerHTML = `<div class="small muted">æš‚æ— å®¢æˆ·ã€‚ç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºå®¢æˆ·â€ã€‚</div>`;
      return;
    }

    filtered.forEach(c=>{
      const p = clientProgress(c);
      const node = document.createElement('div');
      node.className = 'card';
      node.style.marginBottom = '10px';
      node.innerHTML = `
        <div class="bd">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div>
              <div style="font-weight:900; font-size:14px">${escapeHtml(c.name||'æœªå‘½å')}</div>
              <div class="small muted">æ¡£æœŸï¼š${escapeHtml(fmtDate(c.date))} ï½œ çŠ¶æ€ï¼š${escapeHtml(labelStatus(c.status))}</div>
              <div class="small muted">${escapeHtml(c.phone||'')} ${c.city?('ï½œ '+escapeHtml(c.city)):''}</div>
            </div>
            <div style="text-align:right">
              <span class="pill">${p.pct}%</span>
              <div class="small muted" style="margin-top:6px">${p.done}/${p.total||0}</div>
            </div>
          </div>
          <div class="progress" style="margin-top:10px"><div class="bar" style="width:${p.pct}%"></div></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" data-action="editClient" data-id="${c.id}">âœï¸ ç¼–è¾‘</button>
            <button class="btn" data-action="setCurrentById" data-id="${c.id}">â­ è®¾ä¸ºå½“å‰</button>
            <button class="btn" data-action="goto" data-view="client">ğŸ§¾ æ‰§è¡Œ</button>
            <button class="btn" data-action="goto" data-view="deliver">ğŸ äº¤ä»˜</button>
          </div>
        </div>
      `;
      wrap.appendChild(node);
    });
  }

  function labelStatus(v){
    return ({
      in_progress:'è¿›è¡Œä¸­', booked:'å·²å®šæ¡£', completed:'å·²å®Œæˆ', paused:'æš‚åœ'
    })[v] || 'è¿›è¡Œä¸­';
  }

  function clearClientForm(){
    editingClientId = null;
    $('#clientFormTitle').textContent = 'æ–°å»º / ç¼–è¾‘å®¢æˆ·';
    $('#fName').value = '';
    $('#fDate').value = '';
    $('#fPhone').value = '';
    $('#fWechat').value = '';
    $('#fCity').value = '';
    $('#fStatus').value = 'in_progress';
    $('#fPackage').value = '';
    $('#fBudget').value = '';
    $('#fNotes').value = '';
  }

  function fillClientForm(c){
    editingClientId = c.id;
    $('#clientFormTitle').textContent = 'ç¼–è¾‘å®¢æˆ·ï¼š' + (c.name||'');
    $('#fName').value = c.name||'';
    $('#fDate').value = c.date||'';
    $('#fPhone').value = c.phone||'';
    $('#fWechat').value = c.wechat||'';
    $('#fCity').value = c.city||'';
    $('#fStatus').value = c.status||'in_progress';
    $('#fPackage').value = c.package||'';
    $('#fBudget').value = c.budget||'';
    $('#fNotes').value = c.notes||'';
  }

  function saveClientFromForm(){
    const obj = {
      id: editingClientId || uid(),
      name: $('#fName').value.trim() || 'æœªå‘½åå®¢æˆ·',
      date: $('#fDate').value || '',
      phone: $('#fPhone').value.trim() || '',
      wechat: $('#fWechat').value.trim() || '',
      city: $('#fCity').value.trim() || '',
      status: $('#fStatus').value || 'in_progress',
      package: $('#fPackage').value.trim() || '',
      budget: $('#fBudget').value.trim() || '',
      notes: $('#fNotes').value || '',
      updatedAt: new Date().toISOString(),
    };
    const old = getClient(obj.id);
    if(old){
      Object.assign(old, obj);
    }else{
      obj.createdAt = new Date().toISOString();
      obj.checklists = {};
      obj.brief = { conclusion:'', risks:'' };
      obj.deliver = { text:'' };
      state.clients.push(obj);
    }
    save();
    toast('å·²ä¿å­˜', 'å®¢æˆ·ä¿¡æ¯å·²æ›´æ–°ã€‚');
    renderAll();
    return obj.id;
  }

  function deleteClient(id){
    const idx = state.clients.findIndex(c=> c.id===id);
    if(idx>=0){
      const wasCurrent = state.currentClientId===id;
      state.clients.splice(idx,1);
      if(wasCurrent) state.currentClientId = null;
      save();
      toast('å·²åˆ é™¤', 'å®¢æˆ·å·²ç§»é™¤ã€‚');
      clearClientForm();
      renderAll();
    }
  }

  // ---- templates ----
  let editingTplKey = null;

  function tplArray(){
    return Object.values(state.templates || {});
  }

  function renderTemplateSelects(){
    const select = $('#applyTemplateSelect');
    const select2 = $('#deliverClientSelect');
    const tpls = tplArray().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    select.innerHTML = tpls.map(t=> `<option value="${escapeHtml(t.key)}">${escapeHtml(t.name)}</option>`).join('');
    $('#tplCount').textContent = 'æ¨¡æ¿ï¼š' + tpls.length;

    // deliver select: clients
    const clients = [...state.clients].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    select2.innerHTML = clients.map(c=> `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}ï¼ˆ${escapeHtml(c.date||'æœªå®šæ¡£')}ï¼‰</option>`).join('');
  }

  function renderTplList(){
    const q = ($('#tplSearch').value||'').trim();
    const wrap = $('#tplList');
    wrap.innerHTML = '';
    const arr = tplArray().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    const list = q ? arr.filter(t=> (t.name||'').includes(q)) : arr;
    if(!list.length){
      wrap.innerHTML = `<div class="small muted">æœªæ‰¾åˆ°æ¨¡æ¿ã€‚</div>`;
      return;
    }
    list.forEach(t=>{
      const node = document.createElement('div');
      node.className='card';
      node.style.marginBottom='10px';
      node.innerHTML = `
        <div class="bd">
          <div style="font-weight:900">${escapeHtml(t.name)}</div>
          <div class="small muted">å­—æ®µï¼š${escapeHtml((t.fields||[]).join(' / '))}</div>
          <div class="small muted">è¡Œæ•°ï¼š${(t.rows||[]).length}</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" data-action="editTpl" data-key="${escapeHtml(t.key)}">âœï¸ ç¼–è¾‘</button>
            <button class="btn" data-action="applyTplToCurrent" data-key="${escapeHtml(t.key)}">ğŸ§© å¥—ç”¨åˆ°å½“å‰</button>
          </div>
        </div>
      `;
      wrap.appendChild(node);
    });
  }

  function renderTplEditor(){
    const tbl = $('#tplTable');
    const t = editingTplKey ? state.templates[editingTplKey] : null;
    if(!t){
      $('#tplEditorTitle').textContent = 'æ¨¡æ¿ç¼–è¾‘å™¨';
      tbl.innerHTML = '<tr><td class="small muted">è¯·é€‰æ‹©å·¦ä¾§æ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚</td></tr>';
      return;
    }
    $('#tplEditorTitle').textContent = 'æ¨¡æ¿ç¼–è¾‘ï¼š' + t.name;
    const fields = t.fields || [];
    const rows = t.rows || [];
    let html = '<thead><tr>';
    html += '<th style="width:70px">æ“ä½œ</th>';
    fields.forEach(f=> html += `<th>${escapeHtml(f)}</th>`);
    html += '</tr></thead><tbody>';
    rows.forEach((r, idx)=>{
      html += '<tr>';
      html += `<td>
        <button class="btn" style="padding:6px 8px" data-action="delTplRow" data-idx="${idx}">åˆ </button>
      </td>`;
      fields.forEach(f=>{
        const v = r[f] ?? '';
        html += `<td><textarea data-action="editTplCell" data-idx="${idx}" data-field="${escapeHtml(f)}" style="min-height:46px">${escapeHtml(v)}</textarea></td>`;
      });
      html += '</tr>';
    });
    html += '</tbody>';
    tbl.innerHTML = html;
  }

  function applyTemplateToClient(tplKey, client){
    const t = state.templates[tplKey];
    if(!t) return;
    client.checklists = client.checklists || {};
    // clone rows
    const cloned = (t.rows||[]).map(r=> ({...structuredClone(r), _id: uid(), _done:false}));
    client.checklists[tplKey] = cloned;
    save();
    toast('å·²å¥—ç”¨æ¨¡æ¿', `å·²å°†ã€Œ${t.name}ã€å¥—ç”¨åˆ°è¯¥å®¢æˆ·ã€‚`);
  }

  function resetTemplates(){
    state.templates = structuredClone(DEFAULT_TEMPLATES);
    editingTplKey = null;
    save();
    toast('å·²æ¢å¤é»˜è®¤æ¨¡æ¿', 'æ¨¡æ¿åº“å·²é‡ç½®ã€‚');
    renderAll();
  }

  // ---- client view ----
  let activeChecklistKey = null;

  function renderClientMeta(){
    const c = currentClient();
    const wrap = $('#clientMeta');
    const pill = $('#clientMetaPill');
    if(!c){
      wrap.innerHTML = `<div class="small muted">æœªé€‰æ‹©å®¢æˆ·ã€‚è¯·åœ¨â€œå®¢æˆ·æ¡£æ¡ˆâ€è®¾ä¸ºå½“å‰å®¢æˆ·ã€‚</div>`;
      pill.textContent = 'æœªé€‰æ‹©';
      $('#briefConclusion').value = '';
      $('#briefRisks').value = '';
      return;
    }
    pill.textContent = labelStatus(c.status) + (c.date ? ('ï½œ'+fmtDate(c.date)) : '');
    wrap.innerHTML = `
      <div style="font-size:18px; font-weight:900">${escapeHtml(c.name)}</div>
      <div class="small muted" style="margin-top:6px">
        ç”µè¯ï¼š${escapeHtml(c.phone||'â€”')} ï½œ å¾®ä¿¡ï¼š${escapeHtml(c.wechat||'â€”')}<br/>
        åœ°ç‚¹ï¼š${escapeHtml(c.city||'â€”')} ï½œ å¥—é¤ï¼š${escapeHtml(c.package||'â€”')} ï½œ é¢„ç®—ï¼š${escapeHtml(c.budget||'â€”')}
      </div>
      <div class="sep"></div>
      <div class="small" style="white-space:pre-wrap; line-height:1.7">${escapeHtml(c.notes||'')}</div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn" data-action="goto" data-view="clients">âœï¸ ç¼–è¾‘æ¡£æ¡ˆ</button>
        <button class="btn" data-action="markCompleted">âœ… æ ‡è®°å·²å®Œæˆ</button>
      </div>
    `;
    $('#briefConclusion').value = (c.brief && c.brief.conclusion) ? c.brief.conclusion : '';
    $('#briefRisks').value = (c.brief && c.brief.risks) ? c.brief.risks : '';
  }

  function renderChecklistTabs(){
    const c = currentClient();
    const tabs = $('#checklistTabs');
    tabs.innerHTML = '';
    if(!c) return;
    const lists = c.checklists || {};
    const keys = Object.keys(lists);
    if(!keys.length){
      tabs.innerHTML = `<div class="small muted">è¯¥å®¢æˆ·è¿˜æ²¡æœ‰æ¸…å•ã€‚å…ˆä»å³ä¾§é€‰æ‹©æ¨¡æ¿å¥—ç”¨ã€‚</div>`;
      activeChecklistKey = null;
      $('#checklistTable').innerHTML = '';
      renderClientProgress();
      return;
    }
    if(!activeChecklistKey || !lists[activeChecklistKey]) activeChecklistKey = keys[0];

    keys.forEach(k=>{
      const t = state.templates[k];
      const name = t ? t.name : k;
      const btn = document.createElement('button');
      btn.className = 'tab' + (k===activeChecklistKey ? ' active' : '');
      btn.textContent = name;
      btn.dataset.action = 'switchChecklist';
      btn.dataset.key = k;
      tabs.appendChild(btn);
    });
    renderChecklistTable();
  }

  function renderClientProgress(){
    const c = currentClient();
    if(!c){
      $('#clientBar').style.width='0%';
      $('#clientPct').textContent='0%';
      $('#doneCount').textContent='0';
      $('#todoCount').textContent='0';
      return;
    }
    const p = clientProgress(c);
    $('#clientBar').style.width = p.pct + '%';
    $('#clientPct').textContent = p.pct + '%';
    $('#doneCount').textContent = p.done;
    $('#todoCount').textContent = (p.total - p.done);
  }

  function renderChecklistTable(){
    const c = currentClient();
    const tbl = $('#checklistTable');
    if(!c || !activeChecklistKey){
      tbl.innerHTML = '';
      return;
    }
    const rows = (c.checklists && c.checklists[activeChecklistKey]) ? c.checklists[activeChecklistKey] : [];
    const t = state.templates[activeChecklistKey];
    const fields = t ? (t.fields||[]) : [];
    // Table
    let html = '<thead><tr>';
    html += '<th style="width:70px">å®Œæˆ</th>';
    html += '<th style="width:80px">æ“ä½œ</th>';
    fields.forEach(f=> html += `<th>${escapeHtml(f)}</th>`);
    html += '</tr></thead><tbody>';
    rows.forEach((r, idx)=>{
      const done = !!r._done;
      html += '<tr>';
      html += `<td><div class="check ${done?'done':''}" data-action="toggleDone" data-idx="${idx}">${done?'âœ“':''}</div></td>`;
      html += `<td><button class="btn" style="padding:6px 8px" data-action="delChecklistRow" data-idx="${idx}">åˆ </button></td>`;
      fields.forEach(f=>{
        const v = r[f] ?? '';
        html += `<td><textarea data-action="editChecklistCell" data-idx="${idx}" data-field="${escapeHtml(f)}" style="min-height:46px">${escapeHtml(v)}</textarea></td>`;
      });
      html += '</tr>';
    });
    html += '</tbody>';
    tbl.innerHTML = html;
    renderClientProgress();
  }

  function addChecklistRow(){
    const c = ensureClient();
    if(!c) return;
    if(!activeChecklistKey){
      toast('æ²¡æœ‰æ¸…å•', 'è¯·å…ˆå¥—ç”¨ä¸€ä¸ªæ¨¡æ¿ã€‚');
      return;
    }
    const t = state.templates[activeChecklistKey];
    const fields = t ? (t.fields||[]) : [];
    const obj = {_id: uid(), _done:false};
    fields.forEach(f=> obj[f] = '');
    c.checklists[activeChecklistKey].unshift(obj);
    save();
    renderChecklistTable();
  }

  // ---- training ----
  const TRAINING = [
    {
      title: '01ï½œæ¥å•å¿ƒæ³•ï¼šæŠŠâ€œæµç¨‹â€å˜æˆâ€œä½“éªŒâ€',
      bullets: [
        'ç”¨ä¸€å¼ â€œå®¢æˆ·æ—…ç¨‹åœ°å›¾â€æ‹† 5 ä¸ªè§¦ç‚¹ï¼šå’¨è¯¢â†’ç­¾çº¦â†’å…±åˆ›â†’ç°åœºâ†’å”®åã€‚',
        'æ¯ä¸ªè§¦ç‚¹å¿…é¡»äº§å‡ºå¯äº¤ä»˜ç‰©ï¼šæ¸…å•/è„šæœ¬/æ—¶é—´è½´/ç¡®è®¤è®°å½•/çºªè¦ã€‚',
        'æŠŠâ€œçœ‹ä¸è§çš„åŠªåŠ›â€åšæˆâ€œçœ‹å¾—è§çš„è¯æ®â€ï¼ˆæˆªå›¾ã€æ–‡ä»¶ã€ç¡®è®¤å•ï¼‰ã€‚'
      ],
      practice: 'ç»ƒä¹ ï¼šæŠŠä½ ç°æœ‰çš„æœåŠ¡æ‹†æˆ 5 ä¸ªè§¦ç‚¹ï¼Œæ¯ä¸ªè§¦ç‚¹å†™å‡ºâ€œäº§å‡ºç‰© + è¯æ˜æ–¹å¼ + ä¸‹ä¸€æ­¥â€ã€‚'
    },
    {
      title: '02ï½œç¤ºèŒƒæ‹†è§£ï¼šç»™å®¢æˆ·ä¸€ä¸ªå¯ç†è§£çš„å‚è€ƒæ ·ä¾‹',
      bullets: [
        'å…ˆå±•ç¤º 1 ä¸ªé«˜è´¨é‡æ ·ä¾‹ï¼ˆèª“è¯/æµç¨‹/è„šæœ¬/æ°›å›´å‚è€ƒï¼‰ï¼Œå†æ‹†è§£ç»“æ„ã€‚',
        'æ‹†è§£é¡ºåºï¼šç›®æ ‡â†’ç»“æ„â†’å…³é”®å¥â†’èŠ‚å¥â†’æ³¨æ„äº‹é¡¹ã€‚',
        'è®©å®¢æˆ·åšé€‰æ‹©é¢˜ï¼ˆA/B/Cï¼‰è€Œä¸æ˜¯å¼€æ”¾é¢˜ï¼Œé™ä½å†³ç­–æˆæœ¬ã€‚'
      ],
      practice: 'ç»ƒä¹ ï¼šæŠŠâ€œä¸»æŒå¼€åœº/èª“è¯å¼•å¯¼/æ•¬é…’æµç¨‹â€å„åš 1 ä¸ªæ ·ä¾‹ï¼Œå¹¶æ‹†æˆ 5 æ¡ç»“æ„è¦ç‚¹ã€‚'
    },
    {
      title: '03ï½œå¼•å¯¼å…±åˆ›ï¼šç”¨æé—®æŠŠå®¢æˆ·çš„â€œåŸå› ä¸ä¼˜å…ˆçº§â€è¯´å‡ºæ¥',
      bullets: [
        'æé—®æ¡†æ¶ï¼šä¸ºä»€ä¹ˆé‡è¦ï¼Ÿï¼ˆåŸå› ï¼‰â†’ ä½ æœ€åœ¨æ„ä»€ä¹ˆï¼Ÿï¼ˆä¼˜å…ˆçº§ï¼‰â†’ ä»€ä¹ˆä¸èƒ½æ¥å—ï¼Ÿï¼ˆè¾¹ç•Œï¼‰â†’ è°æ‹æ¿ï¼Ÿï¼ˆå†³ç­–äººï¼‰ã€‚',
        'å€¾å¬åå¿…é¡»å¤è¿°ç¡®è®¤ï¼šç”¨ä¸€å¥è¯å¤è¿° + è®©å®¢æˆ·è¯´â€œå¯¹/ä¸å¯¹â€ã€‚',
        'æŠŠæŠ½è±¡åå¥½è½åˆ°å¯æ‰§è¡Œï¼šç”¨â€œåœºæ™¯/åŠ¨ä½œ/é“å…·/éŸ³ä¹â€å››è¦ç´ è½åœ°ã€‚'
      ],
      practice: 'ç»ƒä¹ ï¼šå†™ 12 ä¸ªâ€œå¼€æ”¾é—®é¢˜ + å¤è¿°ç¡®è®¤å¥ + è¡ŒåŠ¨è½åœ°å¥â€ã€‚'
    },
    {
      title: '04ï½œæ‰§è¡Œç³»ç»Ÿï¼šæ—¶é—´è½´ + è´£ä»»äºº + é¢„æ¡ˆ',
      bullets: [
        'æ—¶é—´è½´ä¸æ˜¯â€œé¡ºåºâ€ï¼Œè€Œæ˜¯â€œè´£ä»»åˆ†é…è¡¨â€ï¼šæ¯ä¸ªèŠ‚ç‚¹è¦å†™ è´Ÿè´£äºº/åˆ°ä½æ—¶é—´/äº¤ä»˜ç‰©/é£é™©ç‚¹ã€‚',
        'æŠŠå¸¸è§é£é™©æ¨¡æ¿åŒ–ï¼šå¤©æ°”/è¿Ÿåˆ°/ç¯å…‰éŸ³å“/é•¿è¾ˆæ„è§/æµç¨‹ä¸´æ—¶å˜åŠ¨ã€‚',
        'æ¯ä¸ªé£é™©è¦æœ‰ A æ–¹æ¡ˆ + B æ–¹æ¡ˆ + è§¦å‘æ¡ä»¶ã€‚'
      ],
      practice: 'ç»ƒä¹ ï¼šç”¨ç³»ç»Ÿé‡Œçš„æ¸…å•æ¨¡æ¿ï¼Œä¸ºä¸€ä¸ªçœŸå®å®¢æˆ·åšâ€œæœ€ç»ˆç‰ˆæ—¶é—´è½´â€å¹¶æ‰“å°ç»™å›¢é˜Ÿã€‚'
    },
    {
      title: '05ï½œä½“éªŒåŠ åˆ†ï¼šæ ‡å‡†åŒ–â€œè¶…é¢„æœŸâ€',
      bullets: [
        'æŠŠæƒŠå–œåšæˆå¯å¤åˆ¶åŠ¨ä½œï¼šä¼šå 10 åˆ†é’Ÿçºªè¦ã€ç°åœºå¤‡ç”¨ç¤¼ç›’ã€äº¤ä»˜ä»ªå¼æ„ŸåŒ…è£…ã€å”®åçºªå¿µæ—¥æé†’ã€‚',
        'åŠ åˆ†ç‚¹å¿…é¡»ä¸å®¢æˆ·æ•…äº‹ç›¸å…³ï¼šä¸æ˜¯å †ç‰©æ–™ï¼Œè€Œæ˜¯â€œå¯¹ä»–ä»¬æœ‰æ„ä¹‰â€ã€‚',
        'è®©å®¢æˆ·æ„¿æ„è½¬ä»‹ç»ï¼šäº¤ä»˜åŒ…é‡Œå†™æ¸…â€œæˆ‘ä¸ºä½ åšäº†ä»€ä¹ˆâ€ä¸â€œä½ å¯ä»¥æ€ä¹ˆåˆ†äº«â€ã€‚'
      ],
      practice: 'ç»ƒä¹ ï¼šä¸ºâ€œä¼šå‰/ä¼šä¸­/ä¼šåâ€å„è®¾è®¡ 1 ä¸ªåŠ åˆ†ç‚¹ï¼Œå¹¶å†™è¿›ä½ çš„æœåŠ¡SOPã€‚'
    },
    {
      title: '06ï½œå¤ç›˜ç³»ç»Ÿï¼šæ¯æ¬¡æ²Ÿé€š 3 åˆ†é’Ÿï¼ŒæŒç»­å‡çº§æ¨¡æ¿',
      bullets: [
        'å›ºå®šå¤ç›˜ä¸‰é—®ï¼šç»“è®ºæ˜¯ä»€ä¹ˆï¼Ÿé£é™©æ˜¯ä»€ä¹ˆï¼Ÿä¸‹ä¸€æ­¥æ˜¯è°åœ¨ä»€ä¹ˆæ—¶å€™åšä»€ä¹ˆï¼Ÿ',
        'æŠŠå¤ç›˜æ²‰æ·€åˆ°æ¨¡æ¿åº“ï¼šè®©ä¸‹ä¸€å•æ›´å¿«ã€æ›´ç¨³ã€æ›´å¥½äº¤ä»˜ã€‚',
        'æ¯æœˆåšä¸€æ¬¡â€œæ¨¡æ¿ä½“æ£€â€ï¼šåˆ æ‰æ— ç”¨å­—æ®µï¼Œè¡¥ä¸Šè¯æ®ä¸è´£ä»»äººã€‚'
      ],
      practice: 'ç»ƒä¹ ï¼šæœ¬å‘¨æ‰€æœ‰æ²Ÿé€šéƒ½ç”¨â€œç»“è®º+é£é™©â€å¡«å†™ï¼Œå¹¶åœ¨æœˆåº•æ•´ç†å‡ºâ€œé«˜é¢‘é£é™©æ¸…å•â€ã€‚'
    }
  ];

  function renderTraining(){
    const wrap = $('#trainingContent');
    wrap.innerHTML = TRAINING.map((m, idx)=>`
      <div class="card" style="margin-bottom:12px">
        <div class="hd"><h2>${escapeHtml(m.title)}</h2><span class="pill">æ¨¡å— ${idx+1}/${TRAINING.length}</span></div>
        <div class="bd" style="line-height:1.75">
          <ul style="margin:0; padding-left:18px">
            ${m.bullets.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}
          </ul>
          <div class="sep"></div>
          <div class="notice"><b>å®æ“ä½œä¸š</b><div class="small" style="margin-top:6px">${escapeHtml(m.practice)}</div></div>
        </div>
      </div>
    `).join('');
  }

  // ---- deliver ----
  function generateDeliver(){
    const cid = $('#deliverClientSelect').value;
    const c = getClient(cid);
    if(!c){ toast('æœªé€‰æ‹©å®¢æˆ·', 'è¯·å…ˆé€‰æ‹©å®¢æˆ·ã€‚'); return; }
    const p = clientProgress(c);
    const brand = state.settings.brandName || 'å™è¿°å©šç¤¼ï½œæœåŠ¡äº¤ä»˜';
    const lines = [];
    lines.push(`${brand}`);
    lines.push(`å®¢æˆ·ï¼š${c.name}  æ¡£æœŸï¼š${c.date||'æœªå®šæ¡£'}  çŠ¶æ€ï¼š${labelStatus(c.status)}`);
    lines.push('');
    lines.push('ã€ä¸€ã€çˆ±æƒ…æ•…äº‹æ‘˜è¦ã€‘');
    lines.push('ï¼ˆå†™æ³•ï¼šèƒŒæ™¯â†’ç›¸é‡â†’å†³å®šâ†’æ‰¿è¯ºã€‚å»ºè®® 120-200 å­—ï¼Œå¯ç›´æ¥ç»™æ–°äººåˆ†äº«ã€‚ï¼‰');
    lines.push('');
    lines.push('ã€äºŒã€å©šç¤¼å½“å¤©æ—¶é—´è½´ï¼ˆæœ€ç»ˆç‰ˆï¼‰ã€‘');
    lines.push('ï¼ˆå†™æ³•ï¼šæ—¶é—´-åœ°ç‚¹-è´Ÿè´£äºº-äº¤ä»˜ç‰©-é£é™©é¢„æ¡ˆï¼‰');
    lines.push('');
    lines.push('ã€ä¸‰ã€å…³é”®é•œå¤´æ¸…å•ï¼ˆæ‘„å½±æ‘„åƒå¯¹æ¥ï¼‰ã€‘');
    lines.push('ï¼ˆå†™æ³•ï¼šå¿…æ‹é•œå¤´/æƒ…ç»ªé•œå¤´/é“å…·é•œå¤´/äº²å‹åˆå½±ï¼‰');
    lines.push('');
    lines.push('ã€å››ã€ç°åœºå½©æ’ä¸æ‰§è¡Œè¦ç‚¹ï¼ˆå›¢é˜Ÿç‰ˆï¼‰ã€‘');
    lines.push('ï¼ˆå†™æ³•ï¼šè°åœ¨ä»€ä¹ˆæ—¶å€™åšä»€ä¹ˆï¼Œå¤‡ç”¨æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼‰');
    lines.push('');
    lines.push('ã€äº”ã€çºªå¿µç‰©æ¸…å•ã€‘');
    lines.push('è¯ä¹¦/èª“è¯/èª“è¨€å¡/åˆå½±/èŠ±è‰ºæ ‡æœ¬/ä¼´æ‰‹ç¤¼/æƒŠå–œç‰©ä»¶/ç°åœºéŸ³é¢‘ç­‰');
    lines.push('');
    lines.push('ã€å…­ã€å”®åå›è®¿ä¸é•¿æœŸå…³ç³»ã€‘');
    lines.push('å»ºè®®ï¼šå©šå 3 å¤©å›è®¿ã€å©šå 30 å¤©æ¸¸è®°/ç›¸å†Œæé†’ã€çºªå¿µæ—¥æé†’ä¸äºŒæ¬¡è½¬ä»‹ç»è¯æœ¯ã€‚');
    lines.push('');
    lines.push(`ã€æ‰§è¡Œè¿›åº¦ã€‘å½“å‰æ¸…å•å®Œæˆåº¦ï¼š${p.pct}%ï¼ˆå·²å®Œæˆ ${p.done} é¡¹ï¼‰`);
    lines.push('');
    lines.push('â€”â€” ä½ å¯ä»¥åœ¨æœ¬ç³»ç»Ÿâ€œé¡¹ç›®æ‰§è¡Œâ€é¡µæŠŠæœ€ç»ˆæ—¶é—´è½´ä¸å…³é”®é•œå¤´æ¸…å•è¡¥é½ï¼Œç„¶åç‚¹å‡»â€œæ‰“å°/ä¿å­˜PDFâ€ã€‚');

    $('#deliverText').value = (c.deliver && c.deliver.text) ? c.deliver.text : lines.join('\n');
    toast('å·²ç”Ÿæˆé¢„è§ˆ', 'äº¤ä»˜åŒ…å†…å®¹å·²å¡«å……ï¼Œå¯ç»§ç»­æ¶¦è‰²ã€‚');
  }

  function saveDeliver(){
    const cid = $('#deliverClientSelect').value;
    const c = getClient(cid);
    if(!c){ toast('æœªé€‰æ‹©å®¢æˆ·',''); return; }
    c.deliver = c.deliver || {text:''};
    c.deliver.text = $('#deliverText').value || '';
    save();
    toast('å·²ä¿å­˜', 'äº¤ä»˜åŒ…å·²å­˜å…¥è¯¥å®¢æˆ·æ¡£æ¡ˆã€‚');
  }

  async function copyDeliver(){
    try{
      await navigator.clipboard.writeText($('#deliverText').value || '');
      toast('å·²å¤åˆ¶', 'äº¤ä»˜åŒ…å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    }catch(e){
      toast('å¤åˆ¶å¤±è´¥', 'æµè§ˆå™¨æƒé™é™åˆ¶ï¼Œå¯æ‰‹åŠ¨å…¨é€‰å¤åˆ¶ã€‚');
    }
  }

  // ---- brief ----
  function saveBrief(){
    const c = ensureClient();
    if(!c) return;
    c.brief = c.brief || {conclusion:'', risks:''};
    c.brief.conclusion = $('#briefConclusion').value || '';
    c.brief.risks = $('#briefRisks').value || '';
    save();
    toast('å·²ä¿å­˜', 'å¤ç›˜å†…å®¹å·²å†™å…¥å®¢æˆ·æ¡£æ¡ˆã€‚');
  }

  // ---- import/export ----
  function exportAll(){
    const filename = `å™è¿°å©šç¤¼_å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
    dl(filename, JSON.stringify(state, null, 2), 'application/json');
    toast('å·²å¯¼å‡º', filename);
  }

  function exportClient(){
    const c = ensureClient();
    if(!c) return;
    const filename = `å®¢æˆ·_${c.name}_${new Date().toISOString().slice(0,10)}.json`.replace(/[\\/:*?"<>|]/g,'_');
    dl(filename, JSON.stringify(c, null, 2), 'application/json');
    toast('å·²å¯¼å‡º', filename);
  }

  function importAll(){
    const input = $('#fileInput');
    input.value = '';
    input.onchange = async ()=>{
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        // naive merge: accept full state or client
        if(obj && obj.clients && obj.templates){
          state = {...structuredClone(defaultState), ...obj};
        }else if(obj && obj.id && obj.name){
          // single client
          const exist = getClient(obj.id);
          if(exist) Object.assign(exist, obj);
          else state.clients.push(obj);
        }else{
          throw new Error('ä¸æ”¯æŒçš„JSONç»“æ„');
        }
        save();
        applyTheme();
        toast('å¯¼å…¥æˆåŠŸ', 'æ•°æ®å·²æ¢å¤ã€‚');
        renderAll();
      }catch(e){
        console.error(e);
        toast('å¯¼å…¥å¤±è´¥', 'è¯·ç¡®è®¤é€‰æ‹©çš„æ˜¯ç³»ç»Ÿå¯¼å‡ºçš„ JSON æ–‡ä»¶ã€‚');
      }
    };
    input.click();
  }

  // ---- settings ----
  function toggleTheme(){
    state.settings.theme = (state.settings.theme==='light') ? 'dark' : 'light';
    save();
    applyTheme();
    toast('å·²åˆ‡æ¢ä¸»é¢˜', state.settings.theme==='light'?'æµ…è‰²':'æ·±è‰²');
  }

  function saveSettings(){
    state.settings.brandName = $('#brandName').value || '';
    save();
    toast('å·²ä¿å­˜è®¾ç½®', 'æ‰“å°é¡µå°†æ˜¾ç¤ºä½ çš„å“ç‰Œåã€‚');
  }

  function wipeAll(){
    if(!confirm('ç¡®å®šè¦æ¸…ç©ºæœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) return;
    localStorage.removeItem(KEY);
    state = structuredClone(defaultState);
    save();
    applyTheme();
    toast('å·²æ¸…ç©º', 'æœ¬åœ°æ•°æ®å·²é‡ç½®ã€‚');
    renderAll();
  }

  // ---- event delegation ----
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-action]');
    if(!t) return;
    const a = t.dataset.action;

    if(a==='openSidebar') return openSidebar();
    if(a==='closeSidebar') return closeSidebar();

    if(a==='goto') return showView(t.dataset.view);

    // Schedule actions
    if(a==='scheduleMode'){
      scheduleMode = t.dataset.mode || 'calendar';
      renderSchedule();
      toast('å·²åˆ‡æ¢', scheduleMode==='calendar'?'æ—¥å†è§†å›¾':'æœˆè®¢å•è§†å›¾');
      return;
    }
    if(a==='schedulePrev'){
      scheduleMonth = addMonth(scheduleMonth, -1);
      renderSchedule();
      return;
    }
    if(a==='scheduleNext'){
      scheduleMonth = addMonth(scheduleMonth, +1);
      renderSchedule();
      return;
    }
    if(a==='scheduleAdd'){
      showView('clients');
      clearClientForm();
      $('#fDate').value = scheduleSelectedDate || (scheduleMonth + '-01');
      toast('æ·»åŠ æ¡£æœŸ', 'å·²é¢„å¡«æ¡£æœŸæ—¥æœŸï¼Œå¡«å†™å®¢æˆ·ä¿¡æ¯åä¿å­˜å³å¯ã€‚');
      return;
    }
    if(a==='openDay'){
      const ds = t.dataset.date;
      // if clicked day in other month, jump month first
      const ym = (ds||'').slice(0,7);
      if(ym && ym!==scheduleMonth){ scheduleMonth = ym; renderSchedule(); }
      openDayModal(ds);
      return;
    }
    if(a==='closeDayModal'){ closeDayModal(); return; }
    if(a==='printDayRun'){
      const ds = scheduleSelectedDate || todayStr();
      printDayRun(ds);
      return;
    }
    if(a==='dayModalAdd'){
      showView('clients');
      clearClientForm();
      $('#fDate').value = scheduleSelectedDate || todayStr();
      toast('å½“å¤©æ–°å¢å®¢æˆ·', 'å·²é¢„å¡«æ¡£æœŸæ—¥æœŸã€‚ä¿å­˜åä¼šè‡ªåŠ¨å‡ºç°åœ¨è¯¥æ—¥æœŸã€‚');
      closeDayModal();
      return;
    }
    if(a==='scheduleEditClient'){
      const c = getClient(t.dataset.id);
      if(c){
        showView('clients');
        fillClientForm(c);
        toast('ç¼–è¾‘å®¢æˆ·', 'å¯åœ¨å³ä¾§ä¿®æ”¹ä¿¡æ¯å¹¶ä¿å­˜ã€‚');
      }
      closeDayModal();
      return;
    }

    if(a==='print') return window.print();

    if(a==='newClient'){
      showView('clients');
      clearClientForm();
      $('#fDate').value = todayStr();
      toast('æ–°å»ºå®¢æˆ·', 'åœ¨å³ä¾§å¡«å†™ä¿¡æ¯å¹¶ç‚¹å‡»ä¿å­˜ã€‚');
      return;
    }

    if(a==='saveClient'){ saveClientFromForm(); return; }
    if(a==='deleteClient'){ if(editingClientId && confirm('ç¡®å®šåˆ é™¤è¯¥å®¢æˆ·ï¼Ÿ')) deleteClient(editingClientId); return; }
    if(a==='setCurrent'){
      const id = editingClientId || (state.clients[0] && state.clients[0].id);
      if(!id){ toast('æ²¡æœ‰å®¢æˆ·', 'å…ˆæ–°å»ºä¸€ä¸ªå®¢æˆ·ã€‚'); return; }
      setCurrentClient(id);
      toast('å·²è®¾ä¸ºå½“å‰å®¢æˆ·', 'å»â€œé¡¹ç›®æ‰§è¡Œâ€å¼€å§‹å¥—ç”¨æ¨¡æ¿ã€‚');
      renderAll();
      return;
    }
    if(a==='setCurrentById'){
      setCurrentClient(t.dataset.id);
      toast('å·²è®¾ä¸ºå½“å‰å®¢æˆ·', 'ç°åœ¨è¿›å…¥é¡¹ç›®æ‰§è¡Œé¡µã€‚');
      renderAll();
      return;
    }
    if(a==='editClient'){
      const c = getClient(t.dataset.id);
      if(c){ fillClientForm(c); }
      return;
    }

    if(a==='applyTemplate'){
      const c = ensureClient(); if(!c) return;
      const key = $('#applyTemplateSelect').value;
      applyTemplateToClient(key, c);
      activeChecklistKey = key;
      renderAll();
      return;
    }
    if(a==='applyTplToCurrent'){
      const c = ensureClient(); if(!c) return;
      const key = t.dataset.key;
      applyTemplateToClient(key, c);
      activeChecklistKey = key;
      renderAll();
      showView('client');
      return;
    }
    if(a==='clearClientChecklists'){
      const c = ensureClient(); if(!c) return;
      if(!confirm('ç¡®å®šæ¸…ç©ºè¯¥å®¢æˆ·æ‰€æœ‰æ¸…å•ï¼Ÿ')) return;
      c.checklists = {};
      activeChecklistKey = null;
      save();
      toast('å·²æ¸…ç©º', 'è¯¥å®¢æˆ·æ¸…å•å·²æ¸…ç©ºã€‚');
      renderAll();
      return;
    }

    if(a==='switchChecklist'){
      activeChecklistKey = t.dataset.key;
      renderChecklistTabs();
      return;
    }

    if(a==='toggleDone'){
      const c = ensureClient(); if(!c) return;
      const idx = parseInt(t.dataset.idx,10);
      const rows = c.checklists[activeChecklistKey] || [];
      rows[idx]._done = !rows[idx]._done;
      save();
      renderChecklistTable();
      return;
    }
    if(a==='delChecklistRow'){
      const c = ensureClient(); if(!c) return;
      const idx = parseInt(t.dataset.idx,10);
      c.checklists[activeChecklistKey].splice(idx,1);
      save();
      renderChecklistTable();
      toast('å·²åˆ é™¤', 'æ¸…å•è¡Œå·²ç§»é™¤ã€‚');
      return;
    }
    if(a==='addChecklistRow'){ addChecklistRow(); return; }

    if(a==='saveBrief'){ saveBrief(); return; }

    if(a==='markCompleted'){
      const c = ensureClient(); if(!c) return;
      c.status = 'completed';
      save();
      toast('å·²å®Œæˆ', 'å®¢æˆ·çŠ¶æ€å·²æ›´æ–°ä¸ºâ€œå·²å®Œæˆâ€ã€‚');
      renderAll();
      return;
    }

    if(a==='editTpl'){
      editingTplKey = t.dataset.key;
      renderTplEditor();
      toast('è¿›å…¥æ¨¡æ¿ç¼–è¾‘', 'ç¼–è¾‘åè‡ªåŠ¨ä¿å­˜ã€‚');
      return;
    }
    if(a==='addTplRow'){
      const ttpl = editingTplKey ? state.templates[editingTplKey] : null;
      if(!ttpl){ toast('æœªé€‰æ‹©æ¨¡æ¿',''); return; }
      const obj = {_id: uid(), _done:false};
      (ttpl.fields||[]).forEach(f=> obj[f]='');
      ttpl.rows = ttpl.rows || [];
      ttpl.rows.unshift(obj);
      save();
      renderTplEditor();
      return;
    }
    if(a==='delTplRow'){
      const ttpl = editingTplKey ? state.templates[editingTplKey] : null;
      if(!ttpl) return;
      const idx = parseInt(t.dataset.idx,10);
      ttpl.rows.splice(idx,1);
      save();
      renderTplEditor();
      return;
    }
    if(a==='deleteTpl'){
      if(!editingTplKey){ toast('æœªé€‰æ‹©æ¨¡æ¿',''); return; }
      if(!confirm('ç¡®å®šåˆ é™¤è¯¥æ¨¡æ¿ï¼Ÿ')) return;
      delete state.templates[editingTplKey];
      editingTplKey = null;
      save();
      toast('å·²åˆ é™¤æ¨¡æ¿','');
      renderAll();
      return;
    }
    if(a==='duplicateTpl'){
      const ttpl = editingTplKey ? state.templates[editingTplKey] : null;
      if(!ttpl){ toast('æœªé€‰æ‹©æ¨¡æ¿',''); return; }
      const newKey = ttpl.key + '_copy_' + uid();
      state.templates[newKey] = {
        ...structuredClone(ttpl),
        key: newKey,
        name: ttpl.name + 'ï¼ˆå¤åˆ¶ï¼‰',
        rows: (ttpl.rows||[]).map(r=> ({...structuredClone(r), _id: uid()}))
      };
      save();
      toast('å·²å¤åˆ¶æ¨¡æ¿','è¯·åœ¨å·¦ä¾§åˆ—è¡¨æ‰¾åˆ°â€œå¤åˆ¶â€ç‰ˆæœ¬è¿›è¡Œç¼–è¾‘ã€‚');
      renderAll();
      return;
    }
    if(a==='resetTemplates'){ resetTemplates(); return; }

    if(a==='export'){ exportAll(); return; }
    if(a==='import'){ importAll(); return; }
    if(a==='exportClient'){ exportClient(); return; }

    if(a==='toggleTheme'){ toggleTheme(); return; }
    if(a==='saveSettings'){ saveSettings(); return; }
    if(a==='wipeAll'){ wipeAll(); return; }

    if(a==='generateDeliver'){ generateDeliver(); return; }
    if(a==='saveDeliver'){ saveDeliver(); return; }
    if(a==='copyDeliver'){ copyDeliver(); return; }
    if(a==='downloadHTML'){ dl('å™è¿°å©šç¤¼_æ¥å•æ‰§è¡Œç³»ç»Ÿ.html', document.documentElement.outerHTML, 'text/html'); return; }
  });

  document.addEventListener('input', (e)=>{
    const t = e.target.closest('[data-action]');
    if(!t) return;
    const a = t.dataset.action;

    if(a==='editChecklistCell'){
      const c = currentClient(); if(!c || !activeChecklistKey) return;
      const idx = parseInt(t.dataset.idx,10);
      const field = t.dataset.field;
      c.checklists[activeChecklistKey][idx][field] = t.value;
      save();
      $('#savePill').textContent = 'å·²ä¿å­˜';
      return;
    }
    if(a==='editTplCell'){
      const tpl = editingTplKey ? state.templates[editingTplKey] : null;
      if(!tpl) return;
      const idx = parseInt(t.dataset.idx,10);
      const field = t.dataset.field;
      tpl.rows[idx][field] = t.value;
      save();
      $('#savePill').textContent = 'å·²ä¿å­˜';
      return;
    }
  });

  $('#clientSearch').addEventListener('input', renderClientList);
  $('#tplSearch').addEventListener('input', renderTplList);

  // ---- sidebar nav clicks ----
  $('#nav').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-view]');
    if(!btn) return;
    showView(btn.dataset.view);
  });


  // ---- schedule (calendar / month list) ----
  let scheduleMode = 'calendar';
  let scheduleMonth = new Date().toISOString().slice(0,7);
  let scheduleSelectedDate = null;

  function ymToParts(ym){
    const [y,m] = (ym||'').split('-').map(x=>parseInt(x,10));
    return {y, m};
  }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function addMonth(ym, delta){
    const {y,m} = ymToParts(ym);
    const d = new Date(y, (m-1)+delta, 1);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }
  function weekdayLabel(){
    // Monday-first
    return ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(x=>`å‘¨${x}`);
  }
  function clientsByDate(){
    const map = {};
    for(const c of state.clients){
      if(!c.date) continue;
      map[c.date] = map[c.date] || [];
      map[c.date].push(c);
    }
    // sort within date
    for(const k in map){
      map[k].sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    }
    return map;
  }

  function renderSchedule(){
    $('#scheduleMonthLabel').textContent = scheduleMonth;
    const calWrap = $('#scheduleCalendar');
    const listWrap = $('#scheduleMonthList');
    const map = clientsByDate();

    // Toggle mode
    if(scheduleMode==='calendar'){
      calWrap.classList.remove('hidden');
      listWrap.classList.add('hidden');
    }else{
      calWrap.classList.add('hidden');
      listWrap.classList.remove('hidden');
    }

    // Calendar render
    const {y,m} = ymToParts(scheduleMonth);
    const first = new Date(y, m-1, 1);
    const daysInMonth = new Date(y, m, 0).getDate();
    // Monday-first index
    const startIdx = (first.getDay() + 6) % 7;
    const totalCells = 42;

    let calHtml = `<div class="calWrap">
      <div class="calHead">${weekdayLabel().map(x=>`<div>${x}</div>`).join('')}</div>
      <div class="calGrid">`;

    // previous month info
    const prevYm = addMonth(scheduleMonth, -1);
    const {y:py, m:pm} = ymToParts(prevYm);
    const prevDays = new Date(py, pm, 0).getDate();

    for(let i=0;i<totalCells;i++){
      let dayNum, out=false, cellYm=scheduleMonth;
      if(i < startIdx){
        out=true;
        dayNum = prevDays - (startIdx-1-i);
        cellYm = prevYm;
      }else if(i >= startIdx + daysInMonth){
        out=true;
        dayNum = i - (startIdx + daysInMonth) + 1;
        cellYm = addMonth(scheduleMonth, +1);
      }else{
        dayNum = i - startIdx + 1;
      }
      const ds = `${cellYm}-${pad2(dayNum)}`;
      const orders = map[ds] || [];
      const has = orders.length>0;
      calHtml += `
        <div class="calDay ${out?'out':''} ${has?'has':''}" data-action="openDay" data-date="${ds}">
          <div class="calNum">${dayNum}</div>
          ${has ? `<div class="calBadge">${orders.length} å•</div>` : ``}
          <div class="calMeta">${has ? orders.slice(0,3).map(o=>escapeHtml(o.name)).join('<br/>') : '<span class="muted">æ— è®¢å•</span>'}</div>
        </div>
      `;
    }
    calHtml += `</div></div>`;
    calWrap.innerHTML = calHtml;

    // Month list render
    const monthClients = state.clients
      .filter(c=> (c.date||'').slice(0,7)===scheduleMonth)
      .sort((a,b)=> (a.date||'').localeCompare(b.date||'') || (a.name||'').localeCompare(b.name||''));
    if(!monthClients.length){
      listWrap.innerHTML = `<div class="small muted">æœ¬æœˆæš‚æ— è®¢å•ã€‚ä½ å¯ä»¥ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ å®¢æˆ·æ¡£æœŸã€ã€‚</div>`;
    }else{
      // group by date
      const groups = {};
      monthClients.forEach(c=>{
        groups[c.date] = groups[c.date] || [];
        groups[c.date].push(c);
      });
      listWrap.innerHTML = Object.keys(groups).sort().map(d=>{
        const items = groups[d].map(c=>`
          <div class="miniCard">
            <div class="top">
              <div>
                <div style="font-weight:900">${escapeHtml(c.name||'æœªå‘½å')}</div>
                <div class="small muted">çŠ¶æ€ï¼š${escapeHtml(labelStatus(c.status))}ï½œç”µè¯ï¼š${escapeHtml(c.phone||'â€”')}</div>
              </div>
              <div class="row">
                <button class="btn" data-action="scheduleEditClient" data-id="${c.id}">âœï¸ ç¼–è¾‘</button>
                <button class="btn" data-action="setCurrentById" data-id="${c.id}">â­ å½“å‰</button>
                <button class="btn" data-action="goto" data-view="client">ğŸ§¾ æ‰§è¡Œ</button>
              </div>
            </div>
          </div>
        `).join('');
        return `<div class="listGroup">
          <div class="dateTitle">${escapeHtml(d)}ï¼ˆ${groups[d].length} å•ï¼‰</div>
          ${items}
        </div>`;
      }).join('');
    }
  }

  function openDayModal(dateStr){
    scheduleSelectedDate = dateStr;
    const map = clientsByDate();
    const orders = map[dateStr] || [];
    $('#dayModalTitle').textContent = `æ¡£æœŸï¼š${dateStr}ï¼ˆ${orders.length} å•ï¼‰`;
    const body = $('#dayModalBody');
    if(!orders.length){
      body.innerHTML = `<div class="small muted">å½“å¤©æš‚æ— è®¢å•ï¼Œç‚¹å‡»å³ä¸Šè§’ã€Œå½“å¤©æ–°å¢å®¢æˆ·ã€å³å¯å¿«é€Ÿåˆ›å»ºã€‚</div>`;
    }else{
      body.innerHTML = orders.map(c=>`
        <div class="miniCard">
          <div class="top">
            <div>
              <div style="font-weight:900">${escapeHtml(c.name||'æœªå‘½å')}</div>
              <div class="small muted">çŠ¶æ€ï¼š${escapeHtml(labelStatus(c.status))}ï½œç”µè¯ï¼š${escapeHtml(c.phone||'â€”')}ï½œåœ°ç‚¹ï¼š${escapeHtml(c.city||'â€”')}</div>
            </div>
            <div class="row">
              <button class="btn" data-action="scheduleEditClient" data-id="${c.id}">âœï¸ ç¼–è¾‘</button>
              <button class="btn" data-action="setCurrentById" data-id="${c.id}">â­ å½“å‰</button>
              <button class="btn" data-action="goto" data-view="client">ğŸ§¾ æ‰§è¡Œ</button>
            </div>
          </div>
        </div>
      `).join('');
    }
    $('#dayModalWrap').classList.remove('hidden');
  }

  function closeDayModal(){
    $('#dayModalWrap').classList.add('hidden');
  }

  // ---- Day run sheet (A4) ----
  function summarizeRow(row, fields){
    // join first 3 non-empty fields for readability
    const parts = [];
    for(const f of fields){
      const v = (row && row[f]) ? String(row[f]).trim() : '';
      if(!v) continue;
      parts.push(v);
      if(parts.length>=3) break;
    }
    // fallback: any keys except meta
    if(!parts.length && row){
      for(const k in row){
        if(k.startsWith('_')) continue;
        const v = String(row[k]||'').trim();
        if(!v) continue;
        parts.push(v);
        if(parts.length>=3) break;
      }
    }
    return parts.join(' ï½œ ');
  }

  function getClientKeyTodos(client, limit=16){
    const lists = client.checklists || {};
    const items = [];
    for(const k in lists){
      const rows = lists[k] || [];
      const tpl = state.templates[k];
      const fields = tpl ? (tpl.fields||[]) : [];
      for(const r of rows){
        if(r && r._done) continue;
        const text = summarizeRow(r, fields);
        if(text) items.push(text);
      }
    }
    // unique + keep order
    const seen = new Set();
    const uniq = [];
    for(const it of items){
      if(seen.has(it)) continue;
      seen.add(it);
      uniq.push(it);
      if(uniq.length>=limit) break;
    }
    return uniq;
  }

  function buildDayRunSheet(dateStr){
    const brand = state.settings.brandName || 'å™è¿°å©šç¤¼ï½œæœåŠ¡äº¤ä»˜';
    const map = clientsByDate();
    const orders = map[dateStr] || [];
    const now = new Date();
    const genTime = now.toLocaleString('zh-CN');

    const header = `
      <div class="a4">
        <div class="meta">
          <div><b>${escapeHtml(brand)}</b><div class="muted">å½“å¤©æ‰§è¡Œå•ï¼ˆA4ï¼‰</div></div>
          <div style="text-align:right">
            <div class="pill">æ¡£æœŸï¼š${escapeHtml(dateStr)}</div>
            <div class="muted" style="margin-top:4px">ç”Ÿæˆï¼š${escapeHtml(genTime)}</div>
          </div>
        </div>
        <h1 style="margin-top:4mm">å½“å¤©æ‰§è¡Œæ€»è§ˆï¼ˆ${orders.length} å•ï¼‰</h1>
        <div class="hr"></div>
    `;

    const empty = `
      <div class="box">
        <b>ä»Šæ—¥æš‚æ— è®¢å•</b>
        <div class="muted" style="margin-top:6px">ä½ å¯ä»¥åœ¨ã€Œæ¡£æœŸè®°å½•ã€ç‚¹å‡»æ—¥æœŸ â†’ å½“å¤©æ–°å¢å®¢æˆ· â†’ ä¿å­˜åå†æ‰“å°ã€‚</div>
      </div>
    `;

    const roleTable = `
      <table>
        <thead><tr>
          <th style="width:18%">è§’è‰²</th><th>è´Ÿè´£äºº / è”ç³»æ–¹å¼ / åˆ°ä½æ—¶é—´ï¼ˆç°åœºæ‰‹å¡«ï¼‰</th>
          <th style="width:18%">è§’è‰²</th><th>è´Ÿè´£äºº / è”ç³»æ–¹å¼ / åˆ°ä½æ—¶é—´ï¼ˆç°åœºæ‰‹å¡«ï¼‰</th>
        </tr></thead>
        <tbody>
          <tr><td>ä¸»æŒ/å¸ä»ª</td><td></td><td>ç­–åˆ’/ç»Ÿç­¹</td><td></td></tr>
          <tr><td>åŒ–å¦†å¸ˆ</td><td></td><td>å©šçº±ç¤¼æœ</td><td></td></tr>
          <tr><td>æ‘„å½±å¸ˆ</td><td></td><td>æ‘„åƒå¸ˆ</td><td></td></tr>
          <tr><td>é…’åº—å¯¹æ¥</td><td></td><td>ç¯å…‰éŸ³å“</td><td></td></tr>
          <tr><td>ç¤¼ç‚®/è½¦é˜Ÿ</td><td></td><td>å…¶ä»–</td><td></td></tr>
        </tbody>
      </table>
    `;

    const blocks = orders.length ? orders.map((c, idx)=>{
      const p = clientProgress(c);
      const todos = getClientKeyTodos(c, 16);
      const todosHtml = todos.length ? `<ol style="margin:6px 0 0; padding-left:18px">${todos.map(x=>`<li style="margin:2px 0">${escapeHtml(x)}</li>`).join('')}</ol>` :
        `<div class="muted" style="margin-top:6px">æš‚æ— æœªå®Œæˆäº‹é¡¹ï¼ˆæˆ–è¿˜æœªå¥—ç”¨æ¸…å•æ¨¡æ¿ï¼‰ã€‚</div>`;

      return `
        <div class="box">
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div>
              <div style="font-size:14px; font-weight:900">${escapeHtml(idx+1)}. ${escapeHtml(c.name||'æœªå‘½å')}</div>
              <div class="muted" style="margin-top:4px; font-size:12px; line-height:1.5">
                ç”µè¯ï¼š${escapeHtml(c.phone||'â€”')} ï½œ å¾®ä¿¡ï¼š${escapeHtml(c.wechat||'â€”')}<br/>
                åœ°ç‚¹ï¼š${escapeHtml(c.city||'â€”')} ï½œ å¥—é¤ï¼š${escapeHtml(c.package||'â€”')} ï½œ é¢„ç®—ï¼š${escapeHtml(c.budget||'â€”')}<br/>
                çŠ¶æ€ï¼š${escapeHtml(labelStatus(c.status))} ï½œ æ‰§è¡Œè¿›åº¦ï¼š${p.pct}%ï¼ˆ${p.done}/${p.total||0}ï¼‰
              </div>
            </div>
            <div class="pill">å®¢æˆ·IDï¼š${escapeHtml(c.id||'')}</div>
          </div>

          <div class="hr"></div>

          <div style="font-weight:900; margin-bottom:4px">å…³é”®æœªå®Œæˆäº‹é¡¹ï¼ˆæœ€å¤š 16 æ¡ï¼Œä¼˜å…ˆç»™ç°åœºæ‰§è¡Œï¼‰</div>
          ${todosHtml}

          <div class="hr"></div>

          <div style="font-weight:900; margin-bottom:4px">å›¢é˜Ÿå¯¹æ¥ï¼ˆå¯æ‰‹å¡«ï¼‰</div>
          ${roleTable}

          <div class="hr"></div>

          <div class="row">
            <div style="flex:1; min-width: 320px">
              <div style="font-weight:900; margin-bottom:4px">é£é™©ä¸é¢„æ¡ˆï¼ˆæ¥è‡ªé¡¹ç›®å¤ç›˜/ç°åœºè¡¥å……ï¼‰</div>
              <div class="noteLines">${escapeHtml((c.brief && (c.brief.risks||c.brief.conclusion)) ? ((c.brief.risks?('é£é™©ï¼š'+c.brief.risks+'\n'):'') + (c.brief.conclusion?('ç»“è®ºï¼š'+c.brief.conclusion):'')) : 'ç°åœºå˜æ›´ã€é•¿è¾ˆæ„è§ã€æµç¨‹è°ƒæ•´ã€å¤©æ°”/è¿Ÿåˆ°ç­‰â€¦â€¦')}</div>
            </div>
            <div style="flex:1; min-width: 320px">
              <div style="font-weight:900; margin-bottom:4px">ç°åœºå¤‡æ³¨ï¼ˆè‡ªç”±è®°å½•ï¼‰</div>
              <div class="noteLines"> </div>
            </div>
          </div>

          <div class="sig">
            <div>æ‰§è¡Œè´Ÿè´£äººç­¾å­—</div>
            <div>å®¢æˆ·ç¡®è®¤/å›æ‰§</div>
          </div>
        </div>
      `;
    }).join('') : empty;

    const footer = `
        <div class="box">
          <b>å¿«é€Ÿæç¤º</b>
          <div class="muted" style="margin-top:6px; line-height:1.55">
            â‘  æ‰“å°å‰å»ºè®®ï¼šåœ¨ã€Œé¡¹ç›®æ‰§è¡Œã€æŠŠæœ€ç»ˆæ—¶é—´è½´/å…³é”®é•œå¤´/è´£ä»»äººè¡¥é½ï¼›<br/>
            â‘¡ ç°åœºä¼˜å…ˆçœ‹ï¼šæœªå®Œæˆäº‹é¡¹ + é£é™©é¢„æ¡ˆï¼›<br/>
            â‘¢ è‹¥æœ‰å¤šå•åŒæ—¥ï¼šæ¯å•æ‰§è¡Œå•ç‹¬é¡µé¢ï¼Œé¿å…æ··ä¹±ã€‚
          </div>
        </div>
      </div>
    `;
    return header + blocks + footer;
  }

  function printDayRun(dateStr){
    const area = $('#printArea');
    area.innerHTML = buildDayRunSheet(dateStr);
    area.classList.add('show');
    document.body.classList.add('printing');
    // allow layout flush
    setTimeout(()=> window.print(), 50);
  }

  window.addEventListener('afterprint', ()=>{
    document.body.classList.remove('printing');
    const area = $('#printArea');
    area.classList.remove('show');
    // keep content for debugging? clear to avoid stale
    area.innerHTML = '';
  });

  // ---- render all ----
  function renderAll(){
    renderHeader();
    renderDashboard();
    renderClientList();
    renderTemplateSelects();
    renderTplList();
    renderTplEditor();
    renderClientMeta();
    renderChecklistTabs();
    renderClientProgress();
    renderTraining();
    renderSchedule();
  }

  // init
  if(!state.clients.length){
    // Seed one example client for first-time UX
    const example = {
      id: uid(),
      name: 'ç¤ºä¾‹å®¢æˆ·ï¼ˆå¯åˆ é™¤ï¼‰',
      date: todayStr(),
      phone: '',
      wechat: '',
      city: '',
      status: 'in_progress',
      package: '',
      budget: '',
      notes: 'æç¤ºï¼šè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å®¢æˆ·ã€‚\nä½ å¯ä»¥ï¼š\n1ï¼‰å»â€œæ¸…å•æ¨¡æ¿åº“â€æŸ¥çœ‹é»˜è®¤æ¨¡æ¿ï¼›\n2ï¼‰åœ¨â€œé¡¹ç›®æ‰§è¡Œâ€é‡Œå¥—ç”¨æ¨¡æ¿ï¼›\n3ï¼‰å‹¾é€‰æ‰§è¡Œé¡¹ï¼›\n4ï¼‰åœ¨â€œçºªå¿µäº¤ä»˜åŒ…â€ç”Ÿæˆäº¤ä»˜å†…å®¹ï¼›\n5ï¼‰å¯¼å‡º JSON åšå¤‡ä»½ã€‚',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      checklists: {},
      brief: {conclusion:'', risks:''},
      deliver: {text:''}
    };
    state.clients.push(example);
    state.currentClientId = example.id;
    save();
  }
  renderAll();
  showView('dashboard');
})();
</script>
</body>
</html>
